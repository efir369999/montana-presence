"""
Montana Bot Handlers ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å j3_statbot
==============================================

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                  ‚ïë
‚ïë   –ó–ê–ö–û–ù: –û–î–ò–ù –ö–õ–Æ–ß. –û–î–ù–ê –ü–û–î–ü–ò–°–¨. –û–î–ò–ù –†–ê–ó.                     ‚ïë
‚ïë                                                                  ‚ïë
‚ïë   –≠—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –í–°–ï–• –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.                              ‚ïë
‚ïë   –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è —Ü–µ–ø–æ—á–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å Genesis. ‚ïë
‚ïë                                                                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

–ü—Ä–∏–Ω—Ü–∏–ø –ü–∞—Ä–µ—Ç–æ 80/20:
- 80% Full Nodes ‚Äî –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (—Å–µ—Ä–≤–µ—Ä—ã, –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞)
- 20% Verified Users ‚Äî –ª—é–¥–∏ ("–¢—ã –∑–¥–µ—Å—å?" –≤ –±–æ—Ç–µ)

–î–æ–±–∞–≤—å —ç—Ç–∏ handlers –≤ j3_statbot_120.py
"""

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ContextTypes, CommandHandler, CallbackQueryHandler,
    MessageHandler, filters, ConversationHandler
)
import asyncio
import time
import random
from pathlib import Path
from datetime import datetime, timezone

try:
    from .presence import (
        PresenceStorage, CognitiveKey, PresenceChallenge, PresenceRecord,
        create_challenge, verify_challenge_response, calculate_next_challenge_interval,
        format_genesis_message, format_challenge_message, format_stats_message,
        TAU2_SECS, VERIFICATION_WINDOW_SECS
    )
    from .node_map import get_node_map, NodeMap
except ImportError:
    from presence import (
        PresenceStorage, CognitiveKey, PresenceChallenge, PresenceRecord,
        create_challenge, verify_challenge_response, calculate_next_challenge_interval,
        format_genesis_message, format_challenge_message, format_stats_message,
        TAU2_SECS, VERIFICATION_WINDOW_SECS
    )
    from node_map import get_node_map, NodeMap


# ============================================================================
# STORAGE (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞)
# ============================================================================

MONTANA_DATA_DIR = Path("./montana_data")
storage = PresenceStorage(MONTANA_DATA_DIR)

# ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–æ—Ç–∞ (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
OWNER_ID = 8552053404  # @junomoneta

# Genesis –≤–ª–∞–¥–µ–ª—å—Ü–∞
OWNER_MARKER = "#–ë–ª–∞–≥–∞—è–≤–µ—Å—Ç—å"
OWNER_LINKS = [
    "https://t.me/mylifethoughts369",
    "https://t.me/mylifeprogram369"
]

# –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ —Ñ–∞–π–ª–∞)
AUTHORIZED_FILE = MONTANA_DATA_DIR / "authorized_users.json"


def load_authorized_users() -> set:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    if AUTHORIZED_FILE.exists():
        import json
        with open(AUTHORIZED_FILE, 'r') as f:
            return set(json.load(f))
    return {OWNER_ID}  # –í–ª–∞–¥–µ–ª–µ—Ü –≤—Å–µ–≥–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω


def save_authorized_users(users: set):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    import json
    MONTANA_DATA_DIR.mkdir(parents=True, exist_ok=True)
    with open(AUTHORIZED_FILE, 'w') as f:
        json.dump(list(users), f)


authorized_users = load_authorized_users()


# ============================================================================
# CONVERSATION STATES
# ============================================================================

WAITING_MARKER = 1
WAITING_COGNITIVE_PROMPT = 2
WAITING_FIRST_RESPONSE = 3


# ============================================================================
# NETWORK CONNECTION AUTHORIZATION (–ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è Genesis)
# ============================================================================

async def request_network_connection(user_id: int, key: CognitiveKey, context: ContextTypes.DEFAULT_TYPE):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É.
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è Genesis Identity.
    """
    keyboard = InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫ —Å–µ—Ç–∏", callback_data=f"net_approve_{user_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"net_deny_{user_id}")
        ]
    ])

    try:
        await context.bot.send_message(
            chat_id=OWNER_ID,
            text=f"…à **–ó–ê–ü–†–û–° –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –°–ï–¢–ò MONTANA**\n\n"
                 f"**–ú–∞—Ä–∫–µ—Ä:** `{key.marker}`\n"
                 f"**Genesis Hash:** `{key.genesis_hash[:32]}...`\n"
                 f"**Public Key:** `{key.public_key[:32]}...`\n"
                 f"**User ID:** `{user_id}`\n\n"
                 f"–ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫ —Å–µ—Ç–∏ Montana?",
            reply_markup=keyboard,
            parse_mode='Markdown'
        )
        return True
    except Exception as e:
        print(f"Error sending network request: {e}")
        return False


async def handle_network_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏.
    """
    query = update.callback_query
    await query.answer()

    # –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç –æ–¥–æ–±—Ä—è—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    if query.from_user.id != OWNER_ID:
        await query.edit_message_text("‚ùå –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ –∫ —Å–µ—Ç–∏.")
        return

    data = query.data

    if data.startswith("net_approve_"):
        user_id = int(data.replace("net_approve_", ""))
        authorized_users.add(user_id)
        save_authorized_users(authorized_users)

        key = storage.get_key(user_id)
        marker = key.marker if key else "Unknown"

        await query.edit_message_text(
            f"…à **–ü–û–î–ö–õ–Æ–ß–ï–ù –ö –°–ï–¢–ò MONTANA**\n\n"
            f"**–ú–∞—Ä–∫–µ—Ä:** {marker}\n"
            f"**User ID:** {user_id}\n\n"
            f"–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Ç—å. –ü—Ä–æ–≤–µ—Ä–∫–∞ ¬´–¢—ã –∑–¥–µ—Å—å?¬ª –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞.",
            parse_mode='Markdown'
        )

        # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å challenge
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"…à **–ü–û–î–ö–õ–Æ–ß–ï–ù –ö –°–ï–¢–ò MONTANA**\n\n"
                     f"–¢–≤–æ–π Genesis Identity `{marker}` –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Ç—å!\n\n"
                     f"–¢–µ–ø–µ—Ä—å —Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫ …à Montana Verified Users (20%).\n\n"
                     f"**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:**\n"
                     f"–ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ¬´–¢—ã –∑–¥–µ—Å—å?¬ª –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ ~1 –º–∏–Ω—É—Ç—É.\n\n"
                     f"–£—Å–ø–µ–π –Ω–∞–∂–∞—Ç—å –∑–∞ 30 —Å–µ–∫ ‚Äî –Ω–∞–∫–æ–ø–∏—à—å –≤—Ä–µ–º—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è.",
                parse_mode='Markdown'
            )

            # –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π challenge (—Å—Ä–∞–∑—É, 30-60 —Å–µ–∫)
            context.job_queue.run_once(
                schedule_challenge,
                when=random.randint(30, 60),
                data={'user_id': user_id, 'chat_id': user_id},
                name=f"challenge_{user_id}"
            )
        except Exception as e:
            print(f"Error notifying user {user_id}: {e}")

    elif data.startswith("net_deny_"):
        user_id = int(data.replace("net_deny_", ""))

        # –£–¥–∞–ª–∏—Ç—å Genesis –µ—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ
        key = storage.get_key(user_id)
        marker = key.marker if key else "Unknown"

        await query.edit_message_text(
            f"‚ùå **–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –û–¢–ö–õ–û–ù–ï–ù–û**\n\n"
            f"**–ú–∞—Ä–∫–µ—Ä:** {marker}\n"
            f"**User ID:** {user_id}",
            parse_mode='Markdown'
        )

        # –£–≤–µ–¥–æ–º–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"‚ùå **–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –°–ï–¢–ò –û–¢–ö–õ–û–ù–ï–ù–û**\n\n"
                     f"–¢–≤–æ–π Genesis Identity `{marker}` –Ω–µ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Ç—å.\n\n"
                     f"–û–±—Ä–∞—Ç–∏—Å—å –∫ –≤–ª–∞–¥–µ–ª—å—Ü—É –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.",
                parse_mode='Markdown'
            )
        except Exception:
            pass


# ============================================================================
# GENESIS CREATION FLOW
# ============================================================================

async def montana_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /montana ‚Äî –Ω–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ Montana Verified Users.

    –î–æ–±–∞–≤—å –≤ main():
        application.add_handler(CommandHandler("montana", montana_start))
    """
    user = update.effective_user
    chat_id = update.effective_chat.id

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ —É–∂–µ –∫–ª—é—á
    # –ü–†–ê–í–ò–õ–û: –û–¥–∏–Ω –∫–ª—é—á, –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å, –æ–¥–∏–Ω —Ä–∞–∑. –≠—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –≤—Å–µ—Ö.
    if storage.has_key(user.id):
        key = storage.get_key(user.id)
        stats = storage.get_user_stats(user.id)
        await update.message.reply_text(
            f"üîë **–ü–†–ê–í–ò–õ–û: –û–¥–∏–Ω –∫–ª—é—á, –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å, –æ–¥–∏–Ω —Ä–∞–∑.**\n\n"
            f"–£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å Genesis Identity!\n\n"
            f"**–ú–∞—Ä–∫–µ—Ä:** {key.marker}\n"
            f"**Genesis Hash:** `{key.genesis_hash[:32]}...`\n"
            f"**–°–æ–∑–¥–∞–Ω:** {datetime.fromtimestamp(key.genesis_timestamp, tz=timezone.utc).strftime('%Y-%m-%d %H:%M:%S UTC')}\n\n"
            f"–≠—Ç–æ —Ç–≤–æ–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π genesis. –ò—Å–ø–æ–ª—å–∑—É–π /montana_stats –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.",
            parse_mode='Markdown'
        )
        return ConversationHandler.END

    # –ù–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ
    await update.message.reply_text(
        "…à **GENESIS IDENTITY ‚Äî Montana Verified Users (20%)**\n\n"
        "**–ó–ê–ö–û–ù: –û–¥–∏–Ω –∫–ª—é—á. –û–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å. –û–¥–∏–Ω —Ä–∞–∑.**\n"
        "–≠—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –≤—Å–µ—Ö –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.\n\n"
        "–¢—ã —Å–æ–∑–¥–∞—ë—à—å —Å–≤–æ–π –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π Genesis.\n"
        "–≠—Ç–æ –Ω–∞—á–∞–ª–æ —Ç–≤–æ–µ–π –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ –ø–æ–¥–ø–∏—Å–µ–π.\n\n"
        "**–ü—Ä–∏–Ω—Ü–∏–ø –ü–∞—Ä–µ—Ç–æ 80/20:**\n"
        "‚Ä¢ 80% ‚Äî Full Nodes (—Å–µ—Ä–≤–µ—Ä—ã)\n"
        "‚Ä¢ 20% ‚Äî Verified Users (–ª—é–¥–∏)\n\n"
        "**–®–∞–≥ 1/3:** –ü—Ä–∏–¥—É–º–∞–π —Å–≤–æ–π –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –º–∞—Ä–∫–µ—Ä.\n\n"
        "–≠—Ç–æ —Ç–≤–æ—è —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å –≤ —Å–µ—Ç–∏.\n\n"
        "–ú–∞—Ä–∫–µ—Ä –¥–æ–ª–∂–µ–Ω:\n"
        "‚Ä¢ –ù–∞—á–∏–Ω–∞—Ç—å—Å—è —Å #\n"
        "‚Ä¢ –ë—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º\n\n"
        "–ü—Ä–∏–º–µ—Ä—ã: #–ë–ª–∞–≥–∞—è–≤–µ—Å—Ç—å, #–ú–æ–π–ü—É—Ç—å, #–°—Ç—Ä–∞–Ω–Ω–∏–∫\n\n"
        "–í–≤–µ–¥–∏ —Å–≤–æ–π –º–∞—Ä–∫–µ—Ä:",
        parse_mode='Markdown'
    )
    return WAITING_MARKER


async def receive_marker(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –º–∞—Ä–∫–µ—Ä –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    marker = update.message.text.strip()

    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    if not marker.startswith('#'):
        await update.message.reply_text(
            "‚ùå –ú–∞—Ä–∫–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å #\n\n–ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞:"
        )
        return WAITING_MARKER

    if ' ' in marker:
        await update.message.reply_text(
            "‚ùå –ú–∞—Ä–∫–µ—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–±–µ–ª–æ–≤\n\n–ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞:"
        )
        return WAITING_MARKER

    if len(marker) < 3:
        await update.message.reply_text(
            "‚ùå –ú–∞—Ä–∫–µ—Ä —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)\n\n–ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞:"
        )
        return WAITING_MARKER

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
    existing_keys = storage.get_all_keys()
    for key in existing_keys:
        if key.marker.lower() == marker.lower():
            await update.message.reply_text(
                f"‚ùå –ú–∞—Ä–∫–µ—Ä {marker} —É–∂–µ –∑–∞–Ω—è—Ç\n\n–í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π:"
            )
            return WAITING_MARKER

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä–∫–µ—Ä –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–º—É –ø—Ä–æ–º–ø—Ç—É
    context.user_data['montana_marker'] = marker

    await update.message.reply_text(
        f"‚úÖ –ú–∞—Ä–∫–µ—Ä **{marker}** –ø—Ä–∏–Ω—è—Ç!\n\n"
        f"**–®–∞–≥ 2/3:** –¢–≤–æ–π –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç.\n\n"
        f"–≠—Ç–æ —Ç–≤–æ—è —Ñ–∏–ª–æ—Å–æ—Ñ–∏—è, –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏—è –∏–ª–∏ –º–∞–Ω—Ç—Ä–∞.\n"
        f"–ß—Ç–æ-—Ç–æ –≤–∞–∂–Ω–æ–µ –¥–ª—è —Ç–µ–±—è.\n\n"
        f"**–ü—Ä–∏–º–µ—Ä:**\n"
        f"_–ñ–∏–∑–Ω—å —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –º–µ–Ω—è –ò–¥–µ–∞–ª—å–Ω–æ!_\n"
        f"_–í—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–µ—â–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏._\n\n"
        f"–í–≤–µ–¥–∏ —Å–≤–æ–π –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç:",
        parse_mode='Markdown'
    )
    return WAITING_COGNITIVE_PROMPT


async def receive_cognitive_prompt(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    cognitive_prompt = update.message.text.strip()

    # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
    if len(cognitive_prompt) < 3:
        await update.message.reply_text(
            "‚ùå –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π.\n\n"
            "–ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:"
        )
        return WAITING_COGNITIVE_PROMPT

    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —à–∞–≥—É
    context.user_data['montana_cognitive_prompt'] = cognitive_prompt

    await update.message.reply_text(
        f"‚úÖ –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω!\n\n"
        f"**–®–∞–≥ 3/3:** –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å:\n\n"
        f"**–¢–´ –ó–î–ï–°–¨?**\n\n"
        f"–ù–∞–ø–∏—à–∏ —á—Ç–æ —É–≥–æ–¥–Ω–æ ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç —Ç–≤–æ–π –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç,\n"
        f"—á–∞—Å—Ç—å —Ç–≤–æ–µ–≥–æ Genesis Block.",
        parse_mode='Markdown'
    )
    return WAITING_FIRST_RESPONSE


async def receive_first_response(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–≤—ã–π –æ—Ç–≤–µ—Ç –∏ —Å–æ–∑–¥–∞—Ç—å Genesis."""
    user = update.effective_user
    first_response = update.message.text.strip()
    marker = context.user_data.get('montana_marker', '#Unknown')
    cognitive_prompt = context.user_data.get('montana_cognitive_prompt', '')

    try:
        # –°–æ–∑–¥–∞—Ç—å –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –∫–ª—é—á
        # –ü–†–ê–í–ò–õ–û: –û–¥–∏–Ω –∫–ª—é—á, –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å, –æ–¥–∏–Ω —Ä–∞–∑. –≠—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –≤—Å–µ—Ö.
        key = storage.create_key(
            user_id=user.id,
            telegram_username=user.username,
            marker=marker,
            cognitive_prompt=cognitive_prompt,
            first_response=first_response
        )

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å genesis —Å–æ–æ–±—â–µ–Ω–∏–µ
        await update.message.reply_text(
            format_genesis_message(key),
            parse_mode='Markdown'
        )

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É
        if user.id == OWNER_ID:
            # –í–ª–∞–¥–µ–ª–µ—Ü –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
            authorized_users.add(user.id)
            save_authorized_users(authorized_users)
            await update.message.reply_text(
                "‚úÖ **–ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ü–û–î–ö–õ–Æ–ß–ï–ù –ö –°–ï–¢–ò**\n\n"
                "–ö–∞–∫ –≤–ª–∞–¥–µ–ª–µ—Ü, —Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–µ—Ç—å Montana.\n\n"
                "–ü–µ—Ä–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ ¬´–¢—ã –∑–¥–µ—Å—å?¬ª –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ ~1 –º–∏–Ω—É—Ç—É.",
                parse_mode='Markdown'
            )
            # –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π challenge (—Å—Ä–∞–∑—É, 30-60 —Å–µ–∫)
            context.job_queue.run_once(
                schedule_challenge,
                when=random.randint(30, 60),
                data={'user_id': user.id, 'chat_id': update.effective_chat.id},
                name=f"challenge_{user.id}"
            )
        else:
            # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤–ª–∞–¥–µ–ª—å—Ü—É
            sent = await request_network_connection(user.id, key, context)
            if sent:
                await update.message.reply_text(
                    "‚è≥ **–ó–ê–ü–†–û–° –ù–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –û–¢–ü–†–ê–í–õ–ï–ù**\n\n"
                    "–¢–≤–æ–π Genesis Identity —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.\n\n"
                    "–û–∂–∏–¥–∞–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å–µ—Ç–∏.\n"
                    "–ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞—á–Ω—É—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ¬´–¢—ã –∑–¥–µ—Å—å?¬ª",
                    parse_mode='Markdown'
                )
            else:
                await update.message.reply_text(
                    "‚ö†Ô∏è Genesis —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –≤–ª–∞–¥–µ–ª—å—Ü—É.\n"
                    "–û–±—Ä–∞—Ç–∏—Å—å –∫ @junomoneta –Ω–∞–ø—Ä—è–º—É—é."
                )

        return ConversationHandler.END

    except ValueError as e:
        # –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        # –ü–†–ê–í–ò–õ–û: –û–¥–∏–Ω –∫–ª—é—á, –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å, –æ–¥–∏–Ω —Ä–∞–∑.
        error_msg = str(e)
        if "—É–∂–µ –∏–º–µ–µ—Ç –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –∫–ª—é—á" in error_msg or "–ü–†–ê–í–ò–õ–û" in error_msg:
            await update.message.reply_text(
                f"‚ùå **–ü–†–ê–í–ò–õ–û: –û–¥–∏–Ω –∫–ª—é—á, –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å, –æ–¥–∏–Ω —Ä–∞–∑.**\n\n"
                f"{error_msg}\n\n"
                f"–≠—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –≤—Å–µ—Ö –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.",
                parse_mode='Markdown'
            )
        else:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        return ConversationHandler.END


async def cancel_genesis(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ Genesis."""
    await update.message.reply_text("‚ùå –°–æ–∑–¥–∞–Ω–∏–µ Genesis –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    return ConversationHandler.END


# ============================================================================
# CHALLENGE SYSTEM
# ============================================================================

async def schedule_challenge(context: ContextTypes.DEFAULT_TYPE):
    """Job callback ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å challenge "–¢—ã –∑–¥–µ—Å—å?"."""
    job_data = context.job.data
    user_id = job_data['user_id']
    chat_id = job_data['chat_id']

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—ë –µ—â—ë –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
    if not storage.has_key(user_id):
        return

    # –°–æ–∑–¥–∞—Ç—å challenge
    tau2_index = int(time.time()) // TAU2_SECS
    challenge = create_challenge(user_id, tau2_index)
    storage.set_challenge(challenge)

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –Ø –ó–î–ï–°–¨", callback_data=f"presence_{challenge.challenge_id}")]
    ])

    try:
        await context.bot.send_message(
            chat_id=chat_id,
            text=format_challenge_message(),
            reply_markup=keyboard,
            parse_mode='Markdown'
        )

        # –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
        context.job_queue.run_once(
            check_challenge_expired,
            when=VERIFICATION_WINDOW_SECS + 1,
            data={'user_id': user_id, 'challenge_id': challenge.challenge_id, 'chat_id': chat_id},
            name=f"check_{challenge.challenge_id}"
        )

    except Exception as e:
        print(f"Error sending challenge to {user_id}: {e}")

    # –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π challenge
    key = storage.get_key(user_id)
    if key:
        # –ü–æ–ª—É—á–∏—Ç—å prev_slice_hash (–∑–∞–≥–ª—É—à–∫–∞ ‚Äî –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ —Å–µ—Ç–∏)
        prev_slice_hash = "0" * 64
        next_interval = calculate_next_challenge_interval(
            prev_slice_hash,
            key.public_key,
            tau2_index
        )

        context.job_queue.run_once(
            schedule_challenge,
            when=next_interval,
            data={'user_id': user_id, 'chat_id': chat_id},
            name=f"challenge_{user_id}"
        )


async def check_challenge_expired(context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ challenge –Ω–µ –±—ã–ª –æ—Ç–≤–µ—á–µ–Ω."""
    job_data = context.job.data
    user_id = job_data['user_id']
    challenge_id = job_data['challenge_id']
    chat_id = job_data['chat_id']

    challenge = storage.get_challenge(user_id)
    if challenge and challenge.challenge_id == challenge_id and not challenge.answered:
        # Challenge –ø—Ä–æ–ø—É—â–µ–Ω
        storage.clear_challenge(user_id)

        try:
            await context.bot.send_message(
                chat_id=chat_id,
                text="‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞.\n\n"
                     "–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–∏–¥—ë—Ç —á–µ—Ä–µ–∑ 1-40 –º–∏–Ω—É—Ç."
            )
        except Exception:
            pass


async def handle_presence_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–Ø –ó–î–ï–°–¨" ‚Äî –®–∞–≥ 1.

    –ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –º–∞—Ä–∫–µ—Ä.
    """
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id
    challenge_id = query.data.replace("presence_", "")

    challenge = storage.get_challenge(user_id)
    if not challenge:
        await query.edit_message_text("‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –∏—Å—Ç–µ–∫–ª–∞.")
        return

    if challenge.challenge_id != challenge_id:
        await query.edit_message_text("‚ùå –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–∂–µ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω–∞.")
        return

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è
    response_time = int(time.time())
    success, message = verify_challenge_response(challenge, response_time)

    if not success:
        storage.clear_challenge(user_id)
        await query.edit_message_text(f"‚ùå {message}")
        return

    # –®–∞–≥ 2: –ó–∞–ø—Ä–æ—Å–∏—Ç—å –ª—é–±–æ–π –æ—Ç–≤–µ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
    context.user_data['pending_challenge'] = {
        'challenge_id': challenge_id,
        'challenge': challenge,
        'button_time': response_time
    }

    await query.edit_message_text(
        f"‚è± **–®–ê–ì 2: –ù–ê–ü–ò–®–ò –ß–¢–û –£–ì–û–î–ù–û**\n\n"
        f"–õ—é–±–æ–π —Ç–µ–∫—Å—Ç. –°–µ—Ç—å –ø–æ–¥–ø–∏—à–µ—Ç –µ–≥–æ —Ç–≤–æ–∏–º –∫–ª—é—á–æ–º.\n\n"
        f"–£ —Ç–µ–±—è 20 —Å–µ–∫—É–Ω–¥.",
        parse_mode='Markdown'
    )


async def handle_marker_response(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –º–∞—Ä–∫–µ—Ä–∞ ‚Äî –®–∞–≥ 2.

    –î–æ–±–∞–≤—å –≤ main():
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_marker_response))
    """
    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ pending challenge
    pending = context.user_data.get('pending_challenge')
    if not pending:
        return  # –ù–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

    challenge_id = pending['challenge_id']
    challenge = pending['challenge']
    button_time = pending['button_time']

    # –û—á–∏—Å—Ç–∏—Ç—å pending
    del context.user_data['pending_challenge']

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è (20 —Å–µ–∫ –Ω–∞ –≤–≤–æ–¥ –º–∞—Ä–∫–µ—Ä–∞)
    now = int(time.time())
    if now - button_time > 20:
        storage.clear_challenge(user_id)
        await update.message.reply_text("‚ùå –í—Ä–µ–º—è –≤—ã—à–ª–æ. –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –≤–≤–æ–¥–∏–ª –º–∞—Ä–∫–µ—Ä.")
        return

    # –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
    key = storage.get_key(user_id)
    if not key:
        await update.message.reply_text("‚ùå –ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    user_response = update.message.text.strip()
    if not user_response:
        storage.clear_challenge(user_id)
        await update.message.reply_text("‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è.")
        return

    # –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å—å: SHA3(marker + response + timestamp)
    from hashlib import sha3_256
    signature_input = f"{key.marker}:{user_response}:{now}"
    signature = sha3_256(signature_input.encode()).hexdigest()[:16]

    # –ó–∞–ø–∏—Å–∞—Ç—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ —Å –ø–æ–¥–ø–∏—Å—å—é
    record = PresenceRecord(
        user_id=user_id,
        tau2_index=challenge.tau2_index,
        timestamp=now,
        challenge_id=challenge_id,
        response_hash=f"{signature}:{user_response[:20]}"
    )
    storage.add_presence(record)

    # –û–±–Ω–æ–≤–∏—Ç—å challenge
    challenge.answered = True
    challenge.answer_timestamp = now
    storage.clear_challenge(user_id)

    # –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = storage.get_user_stats(user_id)

    await update.message.reply_text(
        f"‚úÖ **–ü–†–ò–°–£–¢–°–¢–í–ò–ï –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û**\n\n"
        f"–û—Ç–≤–µ—Ç –ø–æ–¥–ø–∏—Å–∞–Ω —Ç–≤–æ–∏–º –∫–ª—é—á–æ–º.\n\n"
        f"**–ü–æ–¥–ø–∏—Å—å:** `{signature}`\n"
        f"**Streak:** {stats.current_streak} –ø–æ–¥—Ä—è–¥\n"
        f"**–í–µ—Å:** {stats.presence_weight}\n"
        f"**Tier:** œÑ{stats.tier}\n\n"
        f"–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 1-40 –º–∏–Ω—É—Ç.\n\n"
        f"…à `{key.marker}`",
        parse_mode='Markdown'
    )


# ============================================================================
# STATS & INFO COMMANDS
# ============================================================================

async def montana_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /montana_stats ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è.

    –î–æ–±–∞–≤—å –≤ main():
        application.add_handler(CommandHandler("montana_stats", montana_stats))
    """
    user = update.effective_user

    if not storage.has_key(user.id):
        await update.message.reply_text(
            "‚ùå –£ —Ç–µ–±—è –Ω–µ—Ç Genesis Identity.\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π /montana –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."
        )
        return

    key = storage.get_key(user.id)
    stats = storage.get_user_stats(user.id)

    await update.message.reply_text(
        format_stats_message(stats, key),
        parse_mode='Markdown'
    )


async def montana_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /montana_info ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ.

    –î–æ–±–∞–≤—å –≤ main():
        application.add_handler(CommandHandler("montana_info", montana_info))
    """
    import time
    from datetime import datetime, timezone

    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    GENESIS_TIMESTAMP = 1767916800  # 09.01.2026 00:00:00 UTC
    PIZZA_DAYS = 5000  # –î–Ω–µ–π –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ Pizza Date
    PIZZA_TIMESTAMP = GENESIS_TIMESTAMP + (PIZZA_DAYS * 86400)
    TOTAL_SECONDS = PIZZA_DAYS * 86400  # 432,000,000 —Å–µ–∫
    PAINTING_BASE_VALUE = 69_300_000  # $69.3M ‚Äî –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω—ã (–ø—Ä–æ–¥–∞–∂–∞ Beeple 2021)
    ANNUAL_APPRECIATION = 0.10  # 10% –≥–æ–¥–æ–≤–æ–π —Ä–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏—Å–∫—É—Å—Å—Ç–≤–∞

    # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    now = int(time.time())
    now_dt = datetime.fromtimestamp(now, tz=timezone.utc)
    elapsed_seconds = max(1, now - GENESIS_TIMESTAMP)
    elapsed_days = elapsed_seconds / 86400
    elapsed_years = elapsed_days / 365.25

    # –¶–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω—ã —Ä–∞—Å—Ç—ë—Ç –∫–∞–∂–¥—ã–π –≥–æ–¥
    current_painting_value = PAINTING_BASE_VALUE * ((1 + ANNUAL_APPRECIATION) ** elapsed_years)
    price_per_second = current_painting_value / TOTAL_SECONDS

    # –°–ª–µ–¥—É—é—â–∏–π Pizza Day (22 –º–∞—è)
    def get_next_pizza_day(dt):
        year = dt.year
        pizza_this_year = datetime(year, 5, 22, tzinfo=timezone.utc)
        if dt > pizza_this_year:
            return datetime(year + 1, 5, 22, tzinfo=timezone.utc)
        return pizza_this_year

    next_pizza = get_next_pizza_day(now_dt)
    days_to_next_pizza = (next_pizza - now_dt).days
    years_to_next_pizza = (next_pizza.timestamp() - GENESIS_TIMESTAMP) / (365.25 * 86400)
    next_pizza_painting_value = PAINTING_BASE_VALUE * ((1 + ANNUAL_APPRECIATION) ** years_to_next_pizza)
    next_pizza_price_per_sec = next_pizza_painting_value / TOTAL_SECONDS

    # –ö—É—Ä—Å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö: rate = 1 + (PIZZA_DAYS * 86400 / elapsed_seconds)
    rate_seconds = 1 + (PIZZA_DAYS * 86400 / elapsed_seconds)

    # –ö—É—Ä—Å –≤ USD: —Å–µ–∫—É–Ω–¥—ã √ó —Ü–µ–Ω–∞ —Å–µ–∫—É–Ω–¥—ã
    usd_rate = rate_seconds * price_per_second

    # –ö—É—Ä—Å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π Pizza Day
    next_pizza_elapsed = next_pizza.timestamp() - GENESIS_TIMESTAMP
    next_pizza_rate_seconds = 1 + (PIZZA_DAYS * 86400 / next_pizza_elapsed)
    next_pizza_usd_rate = next_pizza_rate_seconds * next_pizza_price_per_sec

    await update.message.reply_text(
        f"<b>$MONT | 1 $MONT = ${usd_rate:.2f} | {rate_seconds:.0f} —Å–µ–∫</b>\n"
        f"üïê {now_dt.strftime('%Y-%m-%d %H:%M:%S')} UTC\n\n"
        f"<b>–ó–ê–ö–û–ù: –û–¥–∏–Ω –∫–ª—é—á. –û–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å. –û–¥–∏–Ω —Ä–∞–∑.</b>\n\n"
        f"<b>‚îÅ‚îÅ‚îÅ –ö–ê–†–¢–ò–ù–ê 5000 –î–ù–ï–ô ‚îÅ‚îÅ‚îÅ</b>\n"
        f"üñº –ö–∞—Ä—Ç–∏–Ω–∞ –¥–æ—Ä–æ–∂–∞–µ—Ç –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (+10% –≤ –≥–æ–¥)\n"
        f"üíé –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: ${PAINTING_BASE_VALUE/1_000_000:.1f}M (2021)\n"
        f"üìà –°–µ–π—á–∞—Å: ${current_painting_value/1_000_000:.1f}M\n"
        f"‚è± 1 —Å–µ–∫—É–Ω–¥–∞ = ${price_per_second:.4f}\n\n"
        f"<b>‚îÅ‚îÅ‚îÅ –°–ï–ì–û–î–ù–Ø ‚îÅ‚îÅ‚îÅ</b>\n"
        f"üìÖ –î–µ–Ω—å #{elapsed_days:.1f} –æ—Ç Genesis\n"
        f"üí∞ 1 $MONT = <b>${usd_rate:.2f}</b>\n"
        f"‚è± 1 $MONT = {rate_seconds:.0f} —Å–µ–∫—É–Ω–¥\n\n"
        f"<b>‚îÅ‚îÅ‚îÅ üçï PIZZA DAY {next_pizza.year} ‚îÅ‚îÅ‚îÅ</b>\n"
        f"üìÖ {next_pizza.strftime('%Y-%m-%d')} (—á–µ—Ä–µ–∑ {days_to_next_pizza} –¥–Ω)\n"
        f"üñº –ö–∞—Ä—Ç–∏–Ω–∞: ${next_pizza_painting_value/1_000_000:.1f}M\n"
        f"üí∞ 1 $MONT = ${next_pizza_usd_rate:.2f} ({next_pizza_rate_seconds:.0f} —Å–µ–∫)\n\n"
        f"[{'‚ñà' * int(elapsed_days / PIZZA_DAYS * 20)}{'‚ñë' * (20 - int(elapsed_days / PIZZA_DAYS * 20))}] {elapsed_days/PIZZA_DAYS*100:.1f}%\n\n"
        f"/montana ‚Äî —Å–æ–∑–¥–∞—Ç—å Genesis",
        parse_mode='HTML'
    )


async def montana_rate(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /montana_rate ‚Äî –≥—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞ Montana.
    """
    import time
    from datetime import datetime, timezone
    from io import BytesIO

    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    GENESIS_TIMESTAMP = 1767916800  # 09.01.2026 00:00:00 UTC
    PIZZA_DAYS = 5000
    TOTAL_SECONDS = PIZZA_DAYS * 86400  # 432M —Å–µ–∫
    PAINTING_BASE_VALUE = 69_300_000  # $69.3M –±–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
    ANNUAL_APPRECIATION = 0.10  # +10% –≤ –≥–æ–¥

    now = int(time.time())
    now_dt = datetime.fromtimestamp(now, tz=timezone.utc)
    elapsed_seconds = max(1, now - GENESIS_TIMESTAMP)
    elapsed_days = elapsed_seconds / 86400
    elapsed_years = elapsed_days / 365.25

    # –¶–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω—ã —Ä–∞—Å—Ç—ë—Ç
    current_painting_value = PAINTING_BASE_VALUE * ((1 + ANNUAL_APPRECIATION) ** elapsed_years)
    price_per_second = current_painting_value / TOTAL_SECONDS

    # –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å
    rate_seconds = 1 + (PIZZA_DAYS * 86400 / elapsed_seconds)
    usd_rate = rate_seconds * price_per_second

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
    chart_points = []
    milestones = [1, 7, 30, 100, 365, 500, 1000, 2000, 3000, 4000, 5000]

    for day in milestones:
        day_seconds = day * 86400
        day_years = day / 365.25
        painting_at_day = PAINTING_BASE_VALUE * ((1 + ANNUAL_APPRECIATION) ** day_years)
        price_per_sec_at_day = painting_at_day / TOTAL_SECONDS
        rate = 1 + (PIZZA_DAYS * 86400 / day_seconds)
        usd = rate * price_per_sec_at_day
        chart_points.append((day, rate, usd))

    # ASCII –≥—Ä–∞—Ñ–∏–∫ –∫—É—Ä—Å–∞
    ascii_chart = "üìä <b>–ö–£–†–° …à / –í–†–ï–ú–Ø</b>\n\n"
    ascii_chart += "<code>"
    ascii_chart += "–î–µ–Ω—å     ‚îÇ –°–µ–∫/…à     ‚îÇ $/…à\n"
    ascii_chart += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

    for day, rate, usd in chart_points:
        marker = " ‚óÄ –°–ï–ô–ß–ê–°" if abs(day - elapsed_days) < 1 else ""
        ascii_chart += f"{day:>7}  ‚îÇ {rate:>9.0f} ‚îÇ ${usd:.4f}{marker}\n"

    ascii_chart += "</code>\n\n"

    # –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è
    ascii_chart += f"<b>–°–ï–ô–ß–ê–°:</b> –î–µ–Ω—å {elapsed_days:.1f}\n"
    ascii_chart += f"üí∞ 1 …à = <b>${usd_rate:.4f}</b> = {rate_seconds:.0f} —Å–µ–∫\n\n"

    # –í–∏–∑—É–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ (ASCII)
    ascii_chart += "<b>–ö–†–ò–í–ê–Ø –¶–ï–ù–´:</b>\n<code>"
    max_usd = chart_points[0][2]
    for day, rate, usd in chart_points:
        bar_len = int((usd / max_usd) * 20)
        ascii_chart += f"{day:>4}d ‚îÇ{'‚ñà' * bar_len}{'‚ñë' * (20 - bar_len)}‚îÇ ${usd:.2f}\n"
    ascii_chart += "</code>\n"

    await update.message.reply_text(ascii_chart, parse_mode='HTML')

    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å PNG –≥—Ä–∞—Ñ–∏–∫
    try:
        import matplotlib
        matplotlib.use('Agg')
        import matplotlib.pyplot as plt

        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8), facecolor='#1A1A1A')

        days = [p[0] for p in chart_points]
        rates = [p[1] for p in chart_points]
        usds = [p[2] for p in chart_points]

        # –ì—Ä–∞—Ñ–∏–∫ —Å–µ–∫—É–Ω–¥
        ax1.set_facecolor('#1A1A1A')
        ax1.plot(days, rates, color='#D4AF37', linewidth=2, marker='o')
        ax1.axvline(x=elapsed_days, color='#FF4500', linestyle='--', label=f'–°–µ–π—á–∞—Å: –¥–µ–Ω—å {elapsed_days:.0f}')
        ax1.set_xlabel('–î–Ω–∏ –æ—Ç Genesis', color='#888888')
        ax1.set_ylabel('–°–µ–∫—É–Ω–¥ –∑–∞ 1 …à', color='#888888')
        ax1.set_title('–ö–£–†–° …à –í –°–ï–ö–£–ù–î–ê–•', color='#D4AF37', fontweight='bold')
        ax1.tick_params(colors='#888888')
        ax1.grid(True, alpha=0.2)
        ax1.legend(facecolor='#2A2A2A', labelcolor='#888888')
        for spine in ax1.spines.values():
            spine.set_color('#3A3A3A')

        # –ì—Ä–∞—Ñ–∏–∫ USD
        ax2.set_facecolor('#1A1A1A')
        ax2.plot(days, usds, color='#00FF00', linewidth=2, marker='o')
        ax2.axvline(x=elapsed_days, color='#FF4500', linestyle='--', label=f'–°–µ–π—á–∞—Å: ${usd_rate:.4f}')
        ax2.set_xlabel('–î–Ω–∏ –æ—Ç Genesis', color='#888888')
        ax2.set_ylabel('USD –∑–∞ 1 …à', color='#888888')
        ax2.set_title('–ö–£–†–° …à –í USD', color='#00FF00', fontweight='bold')
        ax2.tick_params(colors='#888888')
        ax2.grid(True, alpha=0.2)
        ax2.legend(facecolor='#2A2A2A', labelcolor='#888888')
        for spine in ax2.spines.values():
            spine.set_color('#3A3A3A')

        plt.tight_layout()

        buf = BytesIO()
        plt.savefig(buf, format='png', facecolor='#1A1A1A', edgecolor='none', dpi=100)
        plt.close(fig)
        buf.seek(0)

        await update.message.reply_photo(
            photo=buf,
            caption=f"…à MONTANA | {now_dt.strftime('%Y-%m-%d %H:%M')} UTC\n1 …à = ${usd_rate:.4f}"
        )
    except Exception:
        pass  # –ï—Å–ª–∏ matplotlib –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ ASCII


async def montana_map(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /montana_map ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ä—Ç—É Full Nodes.

    –î–æ–±–∞–≤—å –≤ main():
        application.add_handler(CommandHandler("montana_map", montana_map))
    """
    node_map = get_node_map()

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    text_map = node_map.render_text()
    await update.message.reply_text(text_map)

    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
    try:
        image_bytes = node_map.render_image()
        if image_bytes:
            from io import BytesIO
            await update.message.reply_photo(
                photo=BytesIO(image_bytes),
                caption="–ö–∞—Ä—Ç–∞ Full Nodes Montana. –°—Ç—Ä–∞–Ω—ã —Å —É–∑–ª–∞–º–∏ –∑–∞–∫—Ä–∞—à–µ–Ω—ã –∑–æ–ª–æ—Ç—ã–º."
            )
        else:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ASCII
            ascii_map = node_map.render_ascii_map()
            await update.message.reply_text(f"```\n{ascii_map}\n```", parse_mode='Markdown')
    except Exception as e:
        # Fallback –Ω–∞ ASCII –∫–∞—Ä—Ç—É
        ascii_map = node_map.render_ascii_map()
        await update.message.reply_text(f"```\n{ascii_map}\n```", parse_mode='Markdown')


# ============================================================================
# START COMMAND
# ============================================================================

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    /start ‚Äî –æ–Ω–±–æ—Ä–¥–∏–Ω–≥: –≤–µ–¥—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ —Ä—É–∫—É —á–µ—Ä–µ–∑ –ø—Ä–æ–µ–∫—Ç.
    """
    import time
    from datetime import datetime, timezone
    import html

    user = update.effective_user
    safe_name = html.escape(user.first_name or "User")

    # –¢–µ–∫—É—â–∏–π –∫—É—Ä—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    GENESIS_TIMESTAMP = 1767916800
    PIZZA_DAYS = 5000
    TOTAL_SECONDS = PIZZA_DAYS * 86400  # 432M
    FINAL_PAINTING_VALUE = 69_300_000  # $69.3M
    FINAL_PRICE_PER_SECOND = FINAL_PAINTING_VALUE / TOTAL_SECONDS  # ~$0.16
    now = int(time.time())
    elapsed_seconds = max(1, now - GENESIS_TIMESTAMP)
    rate_seconds = 1 + (PIZZA_DAYS * 86400 / elapsed_seconds)
    usd_rate = rate_seconds * FINAL_PRICE_PER_SECOND

    # –®–∞–≥ 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫—É—Ä—Å $MONT
    await update.message.reply_text(
        f"<b>$MONT | MONTANA NETWORK</b>\n"
        f"üí∞ 1 $MONT = <b>${usd_rate:.2f}</b> ({rate_seconds:.0f} —Å–µ–∫)\n\n"
        f"–ü—Ä–∏–≤–µ—Ç, {safe_name}! üëã\n\n"
        f"–Ø –ø—Ä–æ–≤–µ–¥—É —Ç–µ–±—è —á–µ—Ä–µ–∑ –ø—Ä–æ–µ–∫—Ç Montana.\n"
        f"–ß–∏—Ç–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ ‚Äî —ç—Ç–æ –≤–∞–∂–Ω–æ.",
        parse_mode='HTML'
    )

    await asyncio.sleep(1)

    # –®–∞–≥ 2: –ß—Ç–æ —Ç–∞–∫–æ–µ Montana ‚Äî –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
    await update.message.reply_text(
        f"<b>‚îÅ‚îÅ‚îÅ –®–ê–ì 1: –ß–¢–û –¢–ê–ö–û–ï MONTANA? ‚îÅ‚îÅ‚îÅ</b>\n\n"
        f"Montana ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –≤—Ä–µ–º–µ–Ω–∏.\n\n"
        f"<b>–ò–¥–µ—è –ø—Ä–æ—Å—Ç–∞—è:</b>\n"
        f"–¢—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å —á—Ç–æ —Ç—ã ‚Äî —ç—Ç–æ —Ç—ã.\n"
        f"–ó–∞ –∫–∞–∂–¥–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—à—å –º–æ–Ω–µ—Ç—É.\n\n"
        f"<b>–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:</b>\n"
        f"–û–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫ = –æ–¥–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è.\n"
        f"–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –¥–≤–∞ –∞–∫–∫–∞—É–Ω—Ç–∞.\n"
        f"–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞—Ç—å –¥—Ä—É–≥–æ–º—É.\n\n"
        f"<i>–≠—Ç–æ –∫–∞–∫ –ø–∞—Å–ø–æ—Ä—Ç ‚Äî –æ–Ω –æ–¥–∏–Ω –∏ —Ç–æ–ª—å–∫–æ —Ç–≤–æ–π.</i>",
        parse_mode='HTML'
    )

    await asyncio.sleep(2)

    # –®–∞–≥ 3: –ó–∞—á–µ–º Full Nodes ‚Äî –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
    await update.message.reply_text(
        f"<b>‚îÅ‚îÅ‚îÅ –®–ê–ì 2: –ö–¢–û –•–†–ê–ù–ò–¢ –ú–û–ù–ï–¢–´? ‚îÅ‚îÅ‚îÅ</b>\n\n"
        f"–ú–æ–Ω–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö.\n"
        f"–≠—Ç–∏ —Å–µ—Ä–≤–µ—Ä—ã –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è Full Nodes.\n\n"
        f"<b>–ó–∞—á–µ–º –æ–Ω–∏ –Ω—É–∂–Ω—ã?</b>\n"
        f"–û–Ω–∏ –∫–∞–∫ –±–∞–Ω–∫–∏, –Ω–æ –±–µ–∑ –±–∞–Ω–∫–∏—Ä–æ–≤.\n"
        f"–ù–∏–∫—Ç–æ –Ω–µ –º–æ–∂–µ—Ç —É–∫—Ä–∞—Å—Ç—å –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å.\n\n"
        f"<b>–ì–¥–µ –æ–Ω–∏ —Å—Ç–æ—è—Ç?</b>\n"
        f"üìç –°–µ–π—á–∞—Å –≥–ª–∞–≤–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –≤ –ú–æ—Å–∫–≤–µ.\n"
        f"–°–∫–æ—Ä–æ –±—É–¥—É—Ç –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É.\n\n"
        f"<i>–ú–æ–∂–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞—Ä—Ç—É: /montana_map</i>",
        parse_mode='HTML'
    )

    await asyncio.sleep(2)

    # –®–∞–≥ 4: –î–≤–∞ –ø—É—Ç–∏ ‚Äî –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
    await update.message.reply_text(
        f"<b>‚îÅ‚îÅ‚îÅ –®–ê–ì 3: –î–í–ê –°–ü–û–°–û–ë–ê –ó–ê–†–ê–ë–û–¢–ê–¢–¨ ‚îÅ‚îÅ‚îÅ</b>\n\n"
        f"<b>üñ• –°–ü–û–°–û–ë 1: Full Node</b>\n"
        f"–î–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–≤ –∏ —Ç–µ—Ö–Ω–∏–∫–æ–≤.\n\n"
        f"–¢—ã –ø–æ–∫—É–ø–∞–µ—à—å —Å–µ—Ä–≤–µ—Ä.\n"
        f"–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—à—å –ø—Ä–æ–≥—Ä–∞–º–º—É Montana.\n"
        f"–°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7.\n"
        f"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—à—å $MONT.\n\n"
        f"<i>–≠—Ç–æ –∫–∞–∫ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –±–∞–Ω–∫–æ–º–∞—Ç ‚Äî\n"
        f"–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å.</i>\n\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
        f"<b>üì± –°–ü–û–°–û–ë 2: –≠—Ç–æ—Ç –±–æ—Ç</b>\n"
        f"–î–ª—è –≤—Å–µ—Ö. –ù—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω.\n\n"
        f"–ë–æ—Ç –ø—Ä–∏—à–ª—ë—Ç: ¬´–¢—ã –∑–¥–µ—Å—å?¬ª\n"
        f"–¢—ã –Ω–∞–∂–º—ë—à—å –∫–Ω–æ–ø–∫—É ¬´–Ø –∑–¥–µ—Å—å¬ª.\n"
        f"–ü–æ–ª—É—á–∏—à—å 1 $MONT.\n\n"
        f"<i>–≠—Ç–æ –∫–∞–∫ –æ—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ ‚Äî\n"
        f"—Ç—ã –∑–¥–µ—Å—å, —Ç–µ–±–µ –ø–ª–∞—Ç—è—Ç.</i>\n\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
        f"<b>–ö—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –±–æ–ª—å—à–µ?</b>\n"
        f"Full Node ‚Äî 80% –≤—Å–µ—Ö –º–æ–Ω–µ—Ç\n"
        f"–ë–æ—Ç ‚Äî 20% –≤—Å–µ—Ö –º–æ–Ω–µ—Ç\n\n"
        f"<b>–ù–æ!</b> –ß–µ—Ä–µ–∑ –±–æ—Ç –ø—Ä–æ—â–µ –Ω–∞—á–∞—Ç—å.\n"
        f"–°–µ—Ä–≤–µ—Ä –º–æ–∂–µ—à—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Ç–æ–º.",
        parse_mode='HTML'
    )

    await asyncio.sleep(2)

    # –®–∞–≥ 5: $MONT ‚Äî –∫—Ä–∏–≤–∞—è 5000 –¥–Ω–µ–π
    # –ö–ê–†–¢–ò–ù–ê –¥–æ—Ä–æ–∂–∞–µ—Ç –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (–∫–∞–∫ Beeple's Everydays)
    # –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω—ã –Ω–∞ Pizza Date = $69.3M
    TOTAL_SECONDS_5000_DAYS = PIZZA_DAYS * 86400  # 432,000,000 —Å–µ–∫
    FINAL_PAINTING_VALUE = 69_300_000  # $69.3M –Ω–∞ Pizza Date
    FINAL_PRICE_PER_SECOND = FINAL_PAINTING_VALUE / TOTAL_SECONDS_5000_DAYS  # ~$0.16

    # –¶–µ–Ω–∞ –∫–∞—Ä—Ç–∏–Ω—ã –†–ê–°–¢–Å–¢ –∞—Å–∏–º–ø—Ç–æ—Ç–∏—á–µ—Å–∫–∏
    # –î–µ–Ω—å 1: –∫–∞—Ä—Ç–∏–Ω–∞ –¥–µ—à—ë–≤–∞—è, –î–µ–Ω—å 5000: –∫–∞—Ä—Ç–∏–Ω–∞ = $69.3M
    painting_progress = min(1.0, elapsed_seconds / (PIZZA_DAYS * 86400))
    current_painting_value = FINAL_PAINTING_VALUE * painting_progress
    current_price_per_second = current_painting_value / TOTAL_SECONDS_5000_DAYS

    # –°–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –≤ 1 $MONT (–ø–∞–¥–∞–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
    genesis_rate_seconds = 1 + (PIZZA_DAYS * 86400 / 86400)  # ~5001 —Å–µ–∫
    pizza_rate_seconds = 2.0
    limit_rate_seconds = 1.0

    # –¶–µ–Ω–∞ $MONT = —Å–µ–∫—É–Ω–¥—ã √ó —Ç–µ–∫—É—â–∞—è —Ü–µ–Ω–∞ —Å–µ–∫—É–Ω–¥—ã
    genesis_usd_now = genesis_rate_seconds * FINAL_PRICE_PER_SECOND  # –æ—Ü–µ–Ω–∫–∞ —Å–µ–≥–æ–¥–Ω—è
    today_usd = rate_seconds * current_price_per_second
    pizza_usd = pizza_rate_seconds * FINAL_PRICE_PER_SECOND
    limit_usd = limit_rate_seconds * FINAL_PRICE_PER_SECOND

    await update.message.reply_text(
        f"<b>‚îÅ‚îÅ‚îÅ –®–ê–ì 4: –í–ê–õ–Æ–¢–ê $MONT ‚îÅ‚îÅ‚îÅ</b>\n\n"
        f"<b>$MONT –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–∞—Ä—Ç–∏–Ω–µ.</b>\n"
        f"–ö–∞—Ä—Ç–∏–Ω–∞ = 5000 –¥–Ω–µ–π = 432M —Å–µ–∫—É–Ω–¥.\n"
        f"–ö–∞—Ä—Ç–∏–Ω–∞ –î–û–†–û–ñ–ê–ï–¢ –≤–æ –≤—Ä–µ–º–µ–Ω–∏.\n\n"
        f"<b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?</b>\n"
        f"1 $MONT = —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è.\n"
        f"–°–µ–∫—É–Ω–¥—ã –¥–æ—Ä–æ–∂–∞—é—Ç –≤–º–µ—Å—Ç–µ —Å –∫–∞—Ä—Ç–∏–Ω–æ–π.\n\n"
        f"<b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å?</b>\n"
        f"–ë–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç ¬´–¢—ã –∑–¥–µ—Å—å?¬ª\n"
        f"–ù–∞–∂–º—ë—à—å ‚Üí –ø–æ–ª—É—á–∏—à—å 1 $MONT.\n\n"
        f"<b>‚îÅ‚îÅ‚îÅ –ö–†–ò–í–ê–Ø 5000 –î–ù–ï–ô ‚îÅ‚îÅ‚îÅ</b>\n\n"
        f"<code>"
        f"üìç GENESIS (–¥–µ–Ω—å 1):\n"
        f"   –¢—ã –ø–æ–ª—É—á–∏–ª: {genesis_rate_seconds:.0f} —Å–µ–∫—É–Ω–¥\n"
        f"   –°–µ–≥–æ–¥–Ω—è —Å—Ç–æ–∏—Ç: ${genesis_usd_now:.0f}\n\n"
        f"üìç –°–ï–ì–û–î–ù–Ø (–¥–µ–Ω—å {elapsed_seconds/86400:.0f}):\n"
        f"   –¢—ã –ø–æ–ª—É—á–∏—à—å: {rate_seconds:.0f} —Å–µ–∫—É–Ω–¥\n"
        f"   –°–µ–≥–æ–¥–Ω—è —Å—Ç–æ–∏—Ç: ${today_usd:.2f}\n\n"
        f"üìç PIZZA DATE (–¥–µ–Ω—å 5000):\n"
        f"   –¢—ã –ø–æ–ª—É—á–∏—à—å: {pizza_rate_seconds:.0f} —Å–µ–∫—É–Ω–¥—ã\n"
        f"   –ë—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å: ${pizza_usd:.2f}"
        f"</code>\n\n"
        f"<b>–ö–∞—Ä—Ç–∏–Ω–∞ –Ω–∞ Pizza Date:</b> ${FINAL_PAINTING_VALUE/1_000_000:.1f}M\n"
        f"<b>1 —Å–µ–∫—É–Ω–¥–∞:</b> ${FINAL_PRICE_PER_SECOND:.2f}\n\n"
        f"<b>–í—ã–≤–æ–¥:</b> –†–∞–Ω–Ω–∏–π $MONT = –±–æ–ª—å—à–µ —Å–µ–∫—É–Ω–¥.\n"
        f"–°–µ–∫—É–Ω–¥—ã –¥–æ—Ä–æ–∂–∞—é—Ç ‚Üí —Ç–≤–æ–π $MONT –¥–æ—Ä–æ–∂–∞–µ—Ç!",
        parse_mode='HTML'
    )

    await asyncio.sleep(2)

    # –®–∞–≥ 6: –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é ‚Äî –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
    await update.message.reply_text(
        f"<b>‚îÅ‚îÅ‚îÅ –ß–¢–û –î–ê–õ–¨–®–ï? ‚îÅ‚îÅ‚îÅ</b>\n\n"
        f"–¢—ã —É–∑–Ω–∞–ª —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ:\n"
        f"‚úÖ Montana –ø–ª–∞—Ç–∏—Ç –∑–∞ —Ç–≤–æ—ë –≤—Ä–µ–º—è\n"
        f"‚úÖ –ß–µ–º —Ä–∞–Ω—å—à–µ –Ω–∞—á–Ω—ë—à—å ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ–ª—É—á–∏—à—å\n"
        f"‚úÖ –ù—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω\n\n"
        f"<b>–¢–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥:</b>\n\n"
        f"üëâ –ù–∞–∂–º–∏ /montana\n"
        f"–°–æ–∑–¥–∞–π —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç (Genesis).\n"
        f"–≠—Ç–æ –∑–∞–π–º—ë—Ç 2 –º–∏–Ω—É—Ç—ã.\n\n"
        f"‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n"
        f"<b>–î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
        f"/montana_stats ‚Äî —Å–∫–æ–ª—å–∫–æ —É —Ç–µ–±—è $MONT\n"
        f"/montana_rate ‚Äî —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç $MONT\n"
        f"/montana_map ‚Äî –≥–¥–µ —Å—Ç–æ—è—Ç —Å–µ—Ä–≤–µ—Ä—ã\n\n"
        f"–í–æ–ø—Ä–æ—Å—ã? –ü–∏—à–∏ @junomoneta",
        parse_mode='HTML'
    )


# ============================================================================
# REGISTRATION HELPER
# ============================================================================

def register_montana_handlers(application):
    """
    –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ Montana handlers.

    –î–æ–±–∞–≤—å –≤ main() –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è application:
        from montana_bot.bot_handlers import register_montana_handlers
        register_montana_handlers(application)
    """
    # Start command
    application.add_handler(CommandHandler("start", start_command))

    # Genesis conversation
    genesis_handler = ConversationHandler(
        entry_points=[CommandHandler("montana", montana_start)],
        states={
            WAITING_MARKER: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_marker)],
            WAITING_COGNITIVE_PROMPT: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_cognitive_prompt)],
            WAITING_FIRST_RESPONSE: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_first_response)],
        },
        fallbacks=[CommandHandler("cancel", cancel_genesis)],
    )
    application.add_handler(genesis_handler)

    # Commands
    application.add_handler(CommandHandler("montana_stats", montana_stats))
    application.add_handler(CommandHandler("montana_info", montana_info))
    application.add_handler(CommandHandler("montana_rate", montana_rate))
    application.add_handler(CommandHandler("montana_map", montana_map))

    # Callbacks
    application.add_handler(CallbackQueryHandler(handle_presence_button, pattern="^presence_"))
    application.add_handler(CallbackQueryHandler(handle_network_callback, pattern="^net_"))

    # –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É (—à–∞–≥ 2: –ª—é–±–∞—è –º—ã—Å–ª—å)
    application.add_handler(MessageHandler(
        filters.TEXT & ~filters.COMMAND,
        handle_marker_response
    ), group=1)  # group=1 —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å ConversationHandler

    print("‚úÖ Montana handlers registered")


# ============================================================================
# INTEGRATION CODE FOR j3_statbot_120.py
# ============================================================================

"""
–ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° j3_statbot_120.py
==============================

1. –°–∫–æ–ø–∏—Ä—É–π montana_bot/ –≤ —Ç—É –∂–µ –ø–∞–ø–∫—É –≥–¥–µ j3_statbot_120.py

2. –í j3_statbot_120.py –¥–æ–±–∞–≤—å –∏–º–ø–æ—Ä—Ç –ø–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö –∏–º–ø–æ—Ä—Ç–æ–≤:

    from montana_bot.bot_handlers import register_montana_handlers

3. –í —Ñ—É–Ω–∫—Ü–∏–∏ main() –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è application –¥–æ–±–∞–≤—å:

    # Montana Verified Users (20%)
    register_montana_handlers(application)

4. –ì–æ—Ç–æ–≤–æ! –ö–æ–º–∞–Ω–¥—ã –¥–æ—Å—Ç—É–ø–Ω—ã:
    /montana       ‚Äî —Å–æ–∑–¥–∞—Ç—å Genesis Identity
    /montana_stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
    /montana_info  ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ

–ü–†–ò–ú–ï–† main():

async def main():
    application = ApplicationBuilder().token(TELEGRAM_TOKEN_STAT_BOT).build()

    # ... —Ç–≤–æ–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ handlers ...

    # Montana integration
    from montana_bot.bot_handlers import register_montana_handlers
    register_montana_handlers(application)

    # Run
    await application.run_polling()
"""
