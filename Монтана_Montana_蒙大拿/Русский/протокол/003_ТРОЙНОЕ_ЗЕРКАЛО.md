# 3-Mirror System

**ะัะบะฐะทะพัััะพะนัะธะฒะฐั ัะตัั Montana**
**Montana Protocol v1.0**

---

## Abstract

3-Mirror โ ัะฐัะฟัะตะดะตะปัะฝะฝะฐั ัะธััะตะผะฐ ะธะท 5 ัะทะปะพะฒ ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผ failover. ะัะธ ะฟะฐะดะตะฝะธะธ ะปัะฑัั 4 ะธะท 5 ัะทะปะพะฒ ัะตัั ะฟัะพะดะพะปะถะฐะตั ัะฐะฑะพัะฐัั. ะัะตะผั ะฒะพัััะฐะฝะพะฒะปะตะฝะธั < 10 ัะตะบัะฝะด.

**ะะปััะตะฒะฐั ัะพัะผัะปะฐ:**
```
4/5 ัะทะปะพะฒ ะผะพะณัั ัะฟะฐััั = ัะตัั ะถะธะฒะฐ
ะะพัััะฐะฝะพะฒะปะตะฝะธะต < 10 ัะตะบัะฝะด
```

---

## 1. ะััะธัะตะบัััะฐ

### 1.1 ะฆะตะฟะพัะบะฐ ัะทะปะพะฒ

**ะััะพะดะฝัะน ะบะพะด:** [leader_election.py](../ะฑะพั/leader_election.py)

```python
BOT_CHAIN = [
    ("amsterdam",   "72.56.102.240"),    # PRIMARY
    ("moscow",      "176.124.208.93"),   # MIRROR 1
    ("almaty",      "91.200.148.93"),    # MIRROR 2
    ("spb",         "188.225.58.98"),    # MIRROR 3
    ("novosibirsk", "147.45.147.247"),   # MIRROR 4
]
```

### 1.2 ะะพะปะธ ัะทะปะพะฒ

| ะะพะปั | ะฃะทะตะป | IP | ะคัะฝะบัะธั |
|------|------|----|---------|
| PRIMARY | Amsterdam | 72.56.102.240 | ะะบัะธะฒะฝัะน ะฑะพั |
| MIRROR 1 | Moscow | 176.124.208.93 | Standby |
| MIRROR 2 | Almaty | 91.200.148.93 | Standby |
| MIRROR 3 | SPB | 188.225.58.98 | Standby |
| MIRROR 4 | Novosibirsk | 147.45.147.247 | Standby |

---

## 2. Leader Election

### 2.1 ะะตัะตัะผะธะฝะธัะพะฒะฐะฝะฝัะน ะฒัะฑะพั ะปะธะดะตัะฐ

**ะััะพะดะฝัะน ะบะพะด:** [leader_election.py](../ะฑะพั/leader_election.py)

```python
def am_i_the_master(self) -> bool:
    """
    ะฏ ะผะฐััะตั ะตัะปะธ ะะกะ ัะทะปั ะะ ะผะตะฝั ะฒ ัะตะฟะพัะบะต ะผะตััะฒั.
    """
    for i, (name, ip) in enumerate(self.chain):
        if name == self.my_name:
            return True  # ะะพัะปะธ ะดะพ ัะตะฑั โ ั ะผะฐััะตั
        if check_node_health(ip):
            return False  # ะัะพ-ัะพ ะฒััะต ะถะธะฒ
    return False
```

### 2.2 ะะพะฝััะฐะฝัั ะผะพะฝะธัะพัะธะฝะณะฐ

```python
CHECK_INTERVAL = 5    # ัะตะบัะฝะด ะผะตะถะดั ะฟัะพะฒะตัะบะฐะผะธ
PING_TIMEOUT = 2      # ัะตะบัะฝะด ัะฐะนะผะฐัั ะฟะธะฝะณะฐ
STARTUP_DELAY = 3     # ัะตะบัะฝะด ะฟะตัะตะด ะฟะตัะฒะพะน ะฟัะพะฒะตัะบะพะน
```

---

## 3. Failover Protocol

### 3.1 ะกัะตะฝะฐัะธะน ะฟะฐะดะตะฝะธั Amsterdam

```
1. Amsterdam ะฟะฐะดะฐะตั
2. Moscow ะฟัะพะฒะตััะตั ะบะฐะถะดัะต 5 ัะตะบ: "Amsterdam ะถะธะฒ?"
3. ะงะตัะตะท 5 ัะตะบ: Amsterdam ะผัััะฒ โ Moscow ััะฐะฝะพะฒะธััั MASTER
4. Almaty/SPB/Novosibirsk: Moscow ะถะธะฒ โ ะพััะฐัััั STANDBY
```

### 3.2 ะกัะตะฝะฐัะธะน ะฒะพัััะฐะฝะพะฒะปะตะฝะธั Amsterdam

```
1. Amsterdam ะฟะพะดะฝะธะผะฐะตััั
2. Moscow ะฟัะพะฒะตััะตั: "Amsterdam ะถะธะฒ?"
3. ะะฐ โ Moscow ะพััะฐะฝะฐะฒะปะธะฒะฐะตั polling โ STANDBY
4. Amsterdam ะทะฐะฟััะบะฐะตั polling โ MASTER
```

---

## 4. ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ัะทะปะฐ

**ะััะพะดะฝัะน ะบะพะด:** [leader_election.py](../ะฑะพั/leader_election.py)

```python
def check_node_health(ip: str) -> bool:
    """ะะพะผะฟะปะตะบัะฝะฐั ะฟัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั ัะทะปะฐ"""
    # 1. ICMP ping
    if is_node_alive(ip):
        return True
    # 2. TCP port 22 (SSH)
    if is_node_alive_tcp(ip, 22):
        return True
    # 3. TCP port 443 (HTTPS)
    if is_node_alive_tcp(ip, 443):
        return True
    return False
```

---

## 5. ะะฝัะตะณัะฐัะธั ั ะฑะพัะพะผ

**ะััะพะดะฝัะน ะบะพะด:** [junomontanaagibot.py](../ะฑะพั/junomontanaagibot.py)

```python
async def run_with_3mirror():
    leader = get_leader_election()

    await leader.run_leader_loop(
        on_become_master=start_polling,
        on_become_standby=stop_polling
    )
```

---

## 6. ะะตะฟะปะพะน

### 6.1 Systemd service

```bash
# /etc/systemd/system/junona.service
Environment="MONTANA_NODE_NAME=amsterdam"
```

### 6.2 ะกะบัะธะฟั ะดะตะฟะปะพั

**ะััะพะดะฝัะน ะบะพะด:** [deploy_nodes.sh](../ะฑะพั/deploy_nodes.sh)

```bash
./deploy_nodes.sh
```

---

## 7. Breathing Sync โ Git ัะธะฝััะพะฝะธะทะฐัะธั

### 7.1 ะะตัะฐะฝะธะทะผ

**ะััะพะดะฝัะน ะบะพะด:** [breathing_sync.py](../ะฑะพั/breathing_sync.py)

```python
# ะะฐะถะดัะต 12 ัะตะบัะฝะด ัะทะปั "ะดััะฐั"
SYNC_INTERVAL_SEC = 12

def breathe():
    inhale()  # git pull โ ะฟะพะปััะฐะตะผ ะธะทะผะตะฝะตะฝะธั
    exhale()  # git push โ ะพัะฟัะฐะฒะปัะตะผ ัะฒะพะธ ะธะทะผะตะฝะตะฝะธั
```

### 7.2 ะะตัะฐัะพัะฐ ะดััะฐะฝะธั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    BREATHING CYCLE                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ซ Inhale (ะฒะดะพั)   โ git pull   โ ะะพะปััะฐะตะผ ะธะท ัะตัะธ        โ
โ  ๐จ Exhale (ะฒัะดะพั)  โ git push   โ ะัะดะฐัะผ ะฒ ัะตัั           โ
โ  ๐ ะฆะธะบะป            โ 12 ัะตะบ     โ ~5 "ะฒะดะพัะพะฒ" ะฒ ะผะธะฝััั    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 7.3 ะกะธะฝััะพะฝะธะทะธััะตะผัะต ัะฐะนะปั

```python
SYNC_PATHS = [
    "data/users.json",       # ะะพะปัะทะพะฒะฐัะตะปะธ
    "node_crypto/nodes.json" # ะฃะทะปั
]
```

**ะกัะฐััั:** โ ะะตะฐะปะธะทะพะฒะฐะฝะพ

---

## 8. TLS ะจะธััะพะฒะฐะฝะธะต

### 8.1 ะะฐัะธััะฝะฝะฐั ัะฒัะทั

**ะััะพะดะฝัะน ะบะพะด:** [node_tls.py](../ะฑะพั/node_tls.py)

```python
# TLS 1.3 ัะธััะพะฒะฐะฝะธะต ะผะตะถะดั ัะทะปะฐะผะธ
SECURE_PORT = 19333
TLS_VERSION = TLSv1_3
```

### 8.2 ะกะตััะธัะธะบะฐัั

ะะฐะถะดัะน ัะทะตะป ะธะผะตะตั self-signed ัะตััะธัะธะบะฐั ั ะฟัะธะฒัะทะบะพะน ะบ ะบัะธะฟัะพะณัะฐัะธัะตัะบะพะผั ะฐะดัะตัั:

```
CN = amsterdam.montana.network
UID = mta46b633d258059b90db46adffc6c5ca08f0e8d6c
```

### 8.3 ะะฐัะธัะฐ ะพั ะฐัะฐะบ

| ะัะฐะบะฐ | ะะฐัะธัะฐ | ะกัะฐััั |
|-------|--------|--------|
| Man-in-the-middle | TLS 1.3 | โ |
| ะะตัะตัะฒะฐั ััะฐัะธะบะฐ | ะจะธััะพะฒะฐะฝะธะต | โ |
| Harvest now, decrypt later | TLS 1.3 + ML-DSA-65 | โ |

**ะกัะฐััั:** โ ะะตะฐะปะธะทะพะฒะฐะฝะพ

---

## 9. ะะตะฐะปะธะทะฐัะธั

| ะะพะผะฟะพะฝะตะฝั | ะคะฐะนะป | ะกัะฐััั |
|-----------|------|--------|
| Leader Election | [leader_election.py](../ะฑะพั/leader_election.py) | โ ะะฐะฑะพัะฐะตั |
| ะัะพะฒะตัะบะฐ ะทะดะพัะพะฒัั | [leader_election.py](../ะฑะพั/leader_election.py) | โ ะะฐะฑะพัะฐะตั |
| Breathing Sync | [breathing_sync.py](../ะฑะพั/breathing_sync.py) | โ ะะฐะฑะพัะฐะตั |
| TLS ะจะธััะพะฒะฐะฝะธะต | [node_tls.py](../ะฑะพั/node_tls.py) | โ ะะฐะฑะพัะฐะตั |
| ะะฝัะตะณัะฐัะธั ั ะฑะพัะพะผ | [junomontanaagibot.py](../ะฑะพั/junomontanaagibot.py) | โ ะะฐะฑะพัะฐะตั |
| ะะตะฟะปะพะน ัะบัะธะฟั | [deploy_nodes.sh](../ะฑะพั/deploy_nodes.sh) | โ ะะพัะพะฒ |

---

```
Alejandro Montana
Montana Protocol v1.0
ะฏะฝะฒะฐัั 2026
```
