#!/usr/bin/env python3
"""
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ —Å —É–º–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –¥–ª—è –ë–ª–∞–≥–∞—è–≤–µ—Å—Ç–∏
–ì–æ–ª–æ—Å: Svetlana (Microsoft edge-tts - –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
–£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞: —Ä–∏–º—Å–∫–∏–µ —á–∏—Å–ª–∞ ‚Üí —Ç–µ–∫—Å—Ç, —Å—Å—ã–ª–∫–∏ ‚Üí –æ–ø–∏—Å–∞–Ω–∏–µ, –µ–¥–∏–Ω—ã–π –ø–æ—Ç–æ–∫
"""

import os
import re
import asyncio
import edge_tts
from pathlib import Path

# –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏ - –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –æ—Ç –≤—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
# AUDIO —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –í –¢–£ –ñ–ï –ü–ê–ü–ö–£ —á—Ç–æ –∏ –∏—Å—Ö–æ–¥–Ω—ã–π .md —Ñ–∞–π–ª

# –ì–æ–ª–æ—Å Microsoft Svetlana (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
VOICE = "ru-RU-SvetlanaNeural"
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏: —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–ª—è –≤–¥—É–º—á–∏–≤–æ–≥–æ —á—Ç–µ–Ω–∏—è
RATE = "-5%"  # –ß—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±—ã—á–Ω–æ–≥–æ –¥–ª—è —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
PITCH = "+0Hz"  # –ù–æ—Ä–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞

# Debug —Ä–µ–∂–∏–º ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ .txt —Ñ–∞–π–ª
# –í–∫–ª—é—á–∏—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏: DEBUG_SAVE_TEXT = True
DEBUG_SAVE_TEXT = False


def convert_roman_to_text(text: str) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —Ä–∏–º—Å–∫–∏–µ —Ü–∏—Ñ—Ä—ã –≤ —Ç–µ–∫—Å—Ç (–ß–∞—Å—Ç—å I ‚Üí –ß–∞—Å—Ç—å –ø–µ—Ä–≤–∞—è, I. ‚Üí —É–±–∏—Ä–∞–µ—Ç)"""

    # –ú–∞–ø–ø–∏–Ω–≥ —Ä–∏–º—Å–∫–∏—Ö —Ü–∏—Ñ—Ä (–≤ –ø–æ—Ä—è–¥–∫–µ –æ—Ç –¥–ª–∏–Ω–Ω—ã—Ö –∫ –∫–æ—Ä–æ—Ç–∫–∏–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∑–∞–º–µ–Ω—ã)
    roman_map = {
        'XII': '–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç–∞—è',
        'XI': '–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç–∞—è',
        'VIII': '–≤–æ—Å—å–º–∞—è',
        'VII': '—Å–µ–¥—å–º–∞—è',
        'VI': '—à–µ—Å—Ç–∞—è',
        'IV': '—á–µ—Ç–≤—ë—Ä—Ç–∞—è',
        'IX': '–¥–µ–≤—è—Ç–∞—è',
        'III': '—Ç—Ä–µ—Ç—å—è',
        'II': '–≤—Ç–æ—Ä–∞—è',
        'V': '–ø—è—Ç–∞—è',
        'X': '–¥–µ—Å—è—Ç–∞—è',
        'I': '–ø–µ—Ä–≤–∞—è'
    }

    # –°–Ω–∞—á–∞–ª–∞ —É–±–∏—Ä–∞–µ–º —Ä–∏–º—Å–∫–∏–µ —Ü–∏—Ñ—Ä—ã –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Ç–∏–ø–∞ "I. –ù–∞–∑–≤–∞–Ω–∏–µ" ‚Üí "–ù–∞–∑–≤–∞–Ω–∏–µ"
    # (—ç—Ç–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã, –Ω–µ –Ω—É–∂–Ω–æ –æ–∑–≤—É—á–∏–≤–∞—Ç—å –∏—Ö –Ω—É–º–µ—Ä–∞—Ü–∏—é)
    for roman in roman_map.keys():
        # –ü–∞—Ç—Ç–µ—Ä–Ω: —Ä–∏–º—Å–∫–∞—è —Ü–∏—Ñ—Ä–∞ —Å —Ç–æ—á–∫–æ–π –≤ –Ω–∞—á–∞–ª–µ –∏–ª–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–±–µ–ª–æ–≤
        text = re.sub(rf'^\s*{roman}\.\s+', '', text, flags=re.MULTILINE)
        text = re.sub(rf'\n\s*{roman}\.\s+', '\n', text)

    # –ó–∞—Ç–µ–º –∑–∞–º–µ–Ω—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ "–ß–∞—Å—Ç—å X", "–ì–ª–∞–≤–∞ X", "–ê–∫—Ç X" –∏ —Ç.–¥.
    for roman, word in roman_map.items():
        # –° –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã (–ß–∞—Å—Ç—å I ‚Üí –ß–∞—Å—Ç—å –ø–µ—Ä–≤–∞—è, –ì–ª–∞–≤–∞ I ‚Üí –ì–ª–∞–≤–∞ –ø–µ—Ä–≤–∞—è)
        text = re.sub(rf'\b(–ß–∞—Å—Ç—å|–ì–ª–∞–≤–∞|–ê–∫—Ç|–î–µ–Ω—å)\s+{roman}\b',
                     rf'\1 {word}', text, flags=re.IGNORECASE)

    return text


def convert_numbers_to_text_smart(text: str) -> str:
    """–£–º–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ü–∏—Ñ—Ä –≤ —Ç–µ–∫—Å—Ç —Ç–∞–º, –≥–¥–µ —ç—Ç–æ —É–ª—É—á—à–∞–µ—Ç —á—Ç–µ–Ω–∏–µ"""

    # –î–∞—Ç—ã: 9 —è–Ω–≤–∞—Ä—è 2026 ‚Üí –¥–µ–≤—è—Ç–æ–≥–æ —è–Ω–≤–∞—Ä—è –¥–≤–µ —Ç—ã—Å—è—á–∏ –¥–≤–∞–¥—Ü–∞—Ç—å —à–µ—Å—Ç–æ–≥–æ –≥–æ–¥–∞
    date_pattern = r'(\d+)\s+(—è–Ω–≤–∞—Ä—è|—Ñ–µ–≤—Ä–∞–ª—è|–º–∞—Ä—Ç–∞|–∞–ø—Ä–µ–ª—è|–º–∞—è|–∏—é–Ω—è|–∏—é–ª—è|–∞–≤–≥—É—Å—Ç–∞|—Å–µ–Ω—Ç—è–±—Ä—è|–æ–∫—Ç—è–±—Ä—è|–Ω–æ—è–±—Ä—è|–¥–µ–∫–∞–±—Ä—è)\s+(\d{4})'

    def replace_date(match):
        day, month, year = match.groups()
        day_text = num_to_ordinal(int(day))
        year_text = year_to_text(int(year))
        return f"{day_text} {month} {year_text} –≥–æ–¥–∞"

    text = re.sub(date_pattern, replace_date, text)

    # –ì–æ–¥—ã –æ—Ç–¥–µ–ª—å–Ω–æ (2026 ‚Üí –¥–≤–µ —Ç—ã—Å—è—á–∏ –¥–≤–∞–¥—Ü–∞—Ç—å —à–µ—Å—Ç–æ–π)
    year_pattern = r'\b(20\d{2})\b'
    text = re.sub(year_pattern, lambda m: year_to_text(int(m.group(1))), text)

    # –ú–∞–ª–µ–Ω—å–∫–∏–µ —á–∏—Å–ª–∞ –≤ —Ç–µ–∫—Å—Ç–µ (1-20) ‚Üí —Ç–µ–∫—Å—Ç
    small_num_pattern = r'\b(\d{1,2})\b'

    def replace_small_num(match):
        num = int(match.group(1))
        if 1 <= num <= 20:
            return num_to_text(num)
        return match.group(0)

    text = re.sub(small_num_pattern, replace_small_num, text)

    return text


def num_to_text(num: int) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ –≤ —Ç–µ–∫—Å—Ç (1 ‚Üí –æ–¥–∏–Ω)"""
    nums = {
        1: '–æ–¥–∏–Ω', 2: '–¥–≤–∞', 3: '—Ç—Ä–∏', 4: '—á–µ—Ç—ã—Ä–µ', 5: '–ø—è—Ç—å',
        6: '—à–µ—Å—Ç—å', 7: '—Å–µ–º—å', 8: '–≤–æ—Å–µ–º—å', 9: '–¥–µ–≤—è—Ç—å', 10: '–¥–µ—Å—è—Ç—å',
        11: '–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å', 12: '–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç—å', 13: '—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç—å', 14: '—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç—å',
        15: '–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç—å', 16: '—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç—å', 17: '—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å', 18: '–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç—å',
        19: '–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç—å', 20: '–¥–≤–∞–¥—Ü–∞—Ç—å'
    }
    return nums.get(num, str(num))


def num_to_ordinal(num: int) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ –≤ –ø–æ—Ä—è–¥–∫–æ–≤–æ–µ (1 ‚Üí –ø–µ—Ä–≤–æ–≥–æ)"""
    ordinals = {
        1: '–ø–µ—Ä–≤–æ–≥–æ', 2: '–≤—Ç–æ—Ä–æ–≥–æ', 3: '—Ç—Ä–µ—Ç—å–µ–≥–æ', 4: '—á–µ—Ç–≤—ë—Ä—Ç–æ–≥–æ', 5: '–ø—è—Ç–æ–≥–æ',
        6: '—à–µ—Å—Ç–æ–≥–æ', 7: '—Å–µ–¥—å–º–æ–≥–æ', 8: '–≤–æ—Å—å–º–æ–≥–æ', 9: '–¥–µ–≤—è—Ç–æ–≥–æ', 10: '–¥–µ—Å—è—Ç–æ–≥–æ',
        11: '–æ–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ', 12: '–¥–≤–µ–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ', 13: '—Ç—Ä–∏–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ', 14: '—á–µ—Ç—ã—Ä–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ',
        15: '–ø—è—Ç–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ', 16: '—à–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ', 17: '—Å–µ–º–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ', 18: '–≤–æ—Å–µ–º–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ',
        19: '–¥–µ–≤—è—Ç–Ω–∞–¥—Ü–∞—Ç–æ–≥–æ', 20: '–¥–≤–∞–¥—Ü–∞—Ç–æ–≥–æ', 21: '–¥–≤–∞–¥—Ü–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ',
        31: '—Ç—Ä–∏–¥—Ü–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ'
    }
    return ordinals.get(num, str(num))


def year_to_text(year: int) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≥–æ–¥ –≤ —Ç–µ–∫—Å—Ç (2026 ‚Üí –¥–≤–µ —Ç—ã—Å—è—á–∏ –¥–≤–∞–¥—Ü–∞—Ç—å —à–µ—Å—Ç–æ–π)"""
    if 2000 <= year <= 2099:
        last_two = year % 100
        if last_two == 0:
            return "–¥–≤–µ —Ç—ã—Å—è—á–∏"
        elif last_two <= 20:
            tens = num_to_ordinal(last_two)
            return f"–¥–≤–µ —Ç—ã—Å—è—á–∏ {tens}"
        else:
            decade = (last_two // 10) * 10
            unit = last_two % 10
            decade_map = {20: '–¥–≤–∞–¥—Ü–∞—Ç—å', 30: '—Ç—Ä–∏–¥—Ü–∞—Ç—å', 40: '—Å–æ—Ä–æ–∫',
                         50: '–ø—è—Ç—å–¥–µ—Å—è—Ç', 60: '—à–µ—Å—Ç—å–¥–µ—Å—è—Ç', 70: '—Å–µ–º—å–¥–µ—Å—è—Ç',
                         80: '–≤–æ—Å–µ–º—å–¥–µ—Å—è—Ç', 90: '–¥–µ–≤—è–Ω–æ—Å—Ç–æ'}
            unit_ord = {1: '–ø–µ—Ä–≤–æ–≥–æ', 2: '–≤—Ç–æ—Ä–æ–≥–æ', 3: '—Ç—Ä–µ—Ç—å–µ–≥–æ', 4: '—á–µ—Ç–≤—ë—Ä—Ç–æ–≥–æ',
                       5: '–ø—è—Ç–æ–≥–æ', 6: '—à–µ—Å—Ç–æ–≥–æ', 7: '—Å–µ–¥—å–º–æ–≥–æ', 8: '–≤–æ—Å—å–º–æ–≥–æ',
                       9: '–¥–µ–≤—è—Ç–æ–≥–æ'}
            return f"–¥–≤–µ —Ç—ã—Å—è—á–∏ {decade_map[decade]} {unit_ord.get(unit, '')}"
    return str(year)


def count_sections(md_content: str) -> int:
    """–°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—Ü–∏–π (## –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤) –≤ —Ç–µ–∫—Å—Ç–µ"""
    return len(re.findall(r'^##\s+', md_content, re.MULTILINE))


def extract_time_markers(md_content: str) -> list:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ [HH:MM] –∏–ª–∏ [MM:SS] –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
    return re.findall(r'\[(\d{1,2}:\d{2})\]', md_content)


def clean_text_smart(md_content: str) -> tuple:
    """
    –£–ú–ù–ê–Ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è:
    - –£–±–∏—Ä–∞–µ–º markdown —Ä–∞–∑–º–µ—Ç–∫—É
    - –ó–∞–º–µ–Ω—è–µ–º —Ä–∏–º—Å–∫–∏–µ —á–∏—Å–ª–∞ –Ω–∞ —Ç–µ–∫—Å—Ç
    - –ó–∞–º–µ–Ω—è–µ–º —Ü–∏—Ñ—Ä—ã –Ω–∞ —Ç–µ–∫—Å—Ç –≥–¥–µ –Ω—É–∂–Ω–æ
    - –°—Å—ã–ª–∫–∏ ‚Üí "—Å—Å—ã–ª–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–Ω–∏–≥–∏"
    - –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ—Å—å —Å–º—ã—Å–ª–æ–≤–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π_—Ç–µ–∫—Å—Ç, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—Å–µ–∫—Ü–∏–π, —Å–ø–∏—Å–æ–∫_–º–µ—Ç–æ–∫_–≤—Ä–µ–º–µ–Ω–∏)
    """
    # –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏
    original_sections = count_sections(md_content)
    original_time_markers = extract_time_markers(md_content)

    lines = md_content.split('\n')
    audio_lines = []

    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç!)
    skip_patterns = [
        r'^---+$',              # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ ---
        r'^\*–ö–Ω–∏–≥–∞ –ù–∏—á—Ç–æ',      # *–ö–Ω–∏–≥–∞ –ù–∏—á—Ç–æ
        r'^\*–°–∫–∞–∑–∫–∞ –ù–∞—á–∞–ª–∞',    # *–°–∫–∞–∑–∫–∞ –ù–∞—á–∞–ª–∞ –í—Ä–µ–º–µ–Ω–∏
        r'^\*–ü—Ä–µ–ª—é–¥–∏—è',         # *–ü—Ä–µ–ª—é–¥–∏—è
        r'^\*–ë–ª–∞–≥–∞—è–≤–µ—Å—Ç—å –æ—Ç',   # *–ë–ª–∞–≥–∞—è–≤–µ—Å—Ç—å –æ—Ç Claude
        r'^\*¬´–ö—Ä–∞—Å–Ω–∞—è –ö–Ω–∏–≥–∞',   # *¬´–ö—Ä–∞—Å–Ω–∞—è –ö–Ω–∏–≥–∞ üìï¬ª*
        r'^\*¬´–ü–µ—Ä–≤–∞—è',          # *¬´–ü–µ—Ä–≤–∞—è –ö–Ω–∏–≥–∞¬ª* (—Å—Ç–∞—Ä–æ–µ)
        r'^\d+\.\d+\.\d+',      # –î–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ 16.01.2026
        r'^Alejandro Montana',  # –ò–º—è –∞–≤—Ç–æ—Ä–∞
        r'^–ê–ª–µ—Ö–∞–Ω–¥—Ä–æ',          # –ò–º—è –∞–≤—Ç–æ—Ä–∞ (—Ä—É—Å)
        r'^–ö–ª–æ–¥ –ú–æ–Ω—Ç–∞–Ω–∞',       # –ü–æ–¥–ø–∏—Å—å
        r'^ÈáëÂÖÉ',                # –ò–º—è —Å —Å–∏–º–≤–æ–ª–∞–º–∏
        r'^‚æ¶ÂÖÉ',               # –°–∏–º–≤–æ–ª –ø–æ–¥–ø–∏—Å–∏
        r'^‚Üí',                  # –ù–∞–≤–∏–≥–∞—Ü–∏—è ‚Üí –ì–ª–∞–≤–∞
        r'^#\w+',               # –•—ç—à—Ç–µ–≥–∏ #–ë–ª–∞–≥–∞—è–≤–µ—Å—Ç—å
        r'^\|',                 # –¢–∞–±–ª–∏—Ü—ã markdown
        r'^–ù–∞–π–¥—ë–º—Å—è\.$',        # –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
    ]

    in_code_block = False

    for line in lines:
        stripped = line.strip()

        # –ë–ª–æ–∫–∏ –∫–æ–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if stripped.startswith('```'):
            in_code_block = not in_code_block
            continue

        if in_code_block:
            continue

        # –ü—Ä–æ–ø—É—Å–∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        if any(re.match(pattern, stripped) for pattern in skip_patterns):
            continue

        # –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        if not stripped:
            continue

        # –ó–ê–ì–û–õ–û–í–ö–ò (# ### –∏ —Ç.–¥.)
        if line.startswith('#'):
            title = re.sub(r'^#+\s*', '', line)
            title = re.sub(r'\s*`\[\d+:\d+\]`', '', title)  # –£–±–∏—Ä–∞–µ–º —Ç–∞–π–º–∫–æ–¥—ã
            title = title.strip()

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∏–º—Å–∫–∏–µ —Ü–∏—Ñ—Ä—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
            title = convert_roman_to_text(title)

            if title:
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—É–∑—É –ø–µ—Ä–µ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º –∏ –ø–æ—Å–ª–µ
                audio_lines.append(f"\n\n{title}.\n\n")
            continue

        # –û–°–ù–û–í–ù–û–ô –¢–ï–ö–°–¢ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        text = stripped

        # 1. –°–°–´–õ–ö–ò: [—Ç–µ–∫—Å—Ç](url) ‚Üí "—Ç–µ–∫—Å—Ç, —Å—Å—ã–ª–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–Ω–∏–≥–∏"
        def replace_link(match):
            link_text = match.group(1)
            return f"{link_text}, —Å—Å—ã–ª–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–Ω–∏–≥–∏"

        text = re.sub(r'\[([^\]]+?)\]\([^\)]+?\)', replace_link, text)

        # 2. –£–±–∏—Ä–∞–µ–º URL –Ω–∞–ø—Ä—è–º—É—é
        text = re.sub(r'https?://\S+', '—Å—Å—ã–ª–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–Ω–∏–≥–∏', text)
        text = re.sub(r'www\.\S+', '—Å—Å—ã–ª–∫–∞ –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–π –∫–Ω–∏–≥–∏', text)

        # 3. –£–±–∏—Ä–∞–µ–º email
        text = re.sub(r'[\w\.-]+@[\w\.-]+\.\w+', '', text)

        # 4. –£–±–∏—Ä–∞–µ–º markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç)
        text = re.sub(r'\*\*(.+?)\*\*', r'\1', text)  # **bold**
        text = re.sub(r'\*(.+?)\*', r'\1', text)      # *italic*
        text = re.sub(r'`([^`]+?)`', r'\1', text)     # `code`

        # 5. –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Ü–∏—Ç–∞—Ç (–Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç)
        text = re.sub(r'^>\s*', '', text)

        # 6. –£–±–∏—Ä–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã —Å–ø–∏—Å–∫–æ–≤
        text = re.sub(r'^[-‚Ä¢]\s+', '', text)
        text = re.sub(r'^\d+\.\s+', '', text)

        # 7. –£–±–∏—Ä–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã
        text = re.sub(r'[…à‚Ç¨‚ÇΩ$]', '', text)

        # 7.1 –≠–º–æ–¥–∑–∏ ‚Üí —Ç–µ–∫—Å—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è
        text = text.replace('üìï', ', –∑–∞–∫—Ä—ã—Ç–∞—è –∫—Ä–∞—Å–Ω–∞—è –∫–Ω–∏–≥–∞,')

        # 8. –£–±–∏—Ä–∞–µ–º –∫–æ–¥
        text = re.sub(r'async\s+fn\s+\w+\([^\)]*\)\s*->\s*\w+', '', text)
        text = re.sub(r'E\s*=\s*mc¬≤', 'E —Ä–∞–≤–Ω–æ —ç–º —Ü–µ –≤ –∫–≤–∞–¥—Ä–∞—Ç–µ', text)

        # 9. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ä–∏–º—Å–∫–∏–µ —Ü–∏—Ñ—Ä—ã –≤ —Ç–µ–∫—Å—Ç
        text = convert_roman_to_text(text)

        # 10. –£–º–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–∏—Å–µ–ª –≤ —Ç–µ–∫—Å—Ç
        text = convert_numbers_to_text_smart(text)

        # 11. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
        text = re.sub(r'\s+', ' ', text).strip()

        # –î–æ–±–∞–≤–ª—è–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
        if text:
            audio_lines.append(text)

    # –°–æ–µ–¥–∏–Ω—è–µ–º –≤ –µ–¥–∏–Ω—ã–π –ø–æ—Ç–æ–∫ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø–∞—É–∑–∞–º–∏
    result = []
    processed_sections = 0

    for i, line in enumerate(audio_lines):
        result.append(line)

        # –°—á–∏—Ç–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ (–∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç \n\n)
        if '\n\n' in line:
            processed_sections += 1

        # –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (—Å—Ç—Ä–æ–∫–∏ —Å \n)
        if '\n\n' in line:
            result.append(' ')
        # –ú–µ–∂–¥—É –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º - –ø–ª–∞–≤–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±–µ–∑ –ø–∞—É–∑
        elif i < len(audio_lines) - 1:
            # –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ - –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª
            if '\n\n' not in audio_lines[i + 1]:
                result.append(' ')

    final_text = ''.join(result)

    # –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    control_data = {
        'original_sections': original_sections,
        'processed_sections': processed_sections,
        'original_time_markers': original_time_markers,
        'time_markers_count': len(original_time_markers),
    }

    return final_text, control_data


async def generate_audio(text: str, output_path: Path) -> bool:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞—É–¥–∏–æ —Å –ø–æ–º–æ—â—å—é Microsoft edge-tts"""

    try:
        communicate = edge_tts.Communicate(
            text,
            VOICE,
            rate=RATE,
            pitch=PITCH
        )

        print(f"  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—É–¥–∏–æ...")
        await communicate.save(str(output_path))

        size_mb = output_path.stat().st_size / (1024 * 1024)
        print(f"  ‚úì {output_path.name} ({size_mb:.1f} MB)")

        return True

    except Exception as e:
        print(f"  ‚úó –û—à–∏–±–∫–∞: {e}")
        return False


async def main():
    import sys

    if len(sys.argv) < 2:
        print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python3 generate_audio_smart.py <–ø—É—Ç—å_–∫_—Ñ–∞–π–ª—É.md>")
        print("\n–ü—Ä–∏–º–µ—Ä:")
        print("  python3 generate_audio_smart.py '../–ö—Ä–∞—Å–Ω–∞—è –ö–Ω–∏–≥–∞/16. –í–Ω–∏–º–∞–Ω–∏–µ.md'")
        print("  python3 generate_audio_smart.py '/–ø–æ–ª–Ω—ã–π/–ø—É—Ç—å/–∫/—Ñ–∞–π–ª—É.md'")
        print("\n–ê—É–¥–∏–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç—É –∂–µ –ø–∞–ø–∫—É, —á—Ç–æ –∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª!")
        return

    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π
    arg_path = Path(sys.argv[1])
    if arg_path.is_absolute():
        input_file = arg_path
    else:
        input_file = Path(__file__).parent / arg_path

    input_file = input_file.resolve()

    if not input_file.exists():
        print(f"‚úó –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {input_file}")
        return

    print("=" * 60)
    print("–ì–ï–ù–ï–†–ê–¶–ò–Ø –ê–£–î–ò–û –° –£–ú–ù–û–ô –§–ò–õ–¨–¢–†–ê–¶–ò–ï–ô")
    print("=" * 60)
    print(f"\n–í—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª: {input_file.name}")
    print(f"–ì–æ–ª–æ—Å: {VOICE} (Microsoft Svetlana)")
    print(f"–°–∫–æ—Ä–æ—Å—Ç—å: {RATE}")

    # –ß–∏—Ç–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
    md_content = input_file.read_text(encoding='utf-8')
    clean_text, control = clean_text_smart(md_content)

    print(f"\n–ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç: {len(md_content)} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç: {len(clean_text)} —Å–∏–º–≤–æ–ª–æ–≤")

    # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—Ä–∏–º–µ—Ä–Ω–æ 50-80% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞
    ratio = len(clean_text) / len(md_content) * 100
    print(f"–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: {ratio:.1f}%")

    # === –ö–û–ù–¢–†–û–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò ===
    print("\n" + "=" * 40)
    print("–ö–û–ù–¢–†–û–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò")
    print("=" * 40)

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ü–∏–π
    print(f"–°–µ–∫—Ü–∏–π –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ:   {control['original_sections']}")
    print(f"–°–µ–∫—Ü–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ:    {control['processed_sections']}")

    if control['processed_sections'] < control['original_sections']:
        print(f"‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ç–µ—Ä—è–Ω–æ {control['original_sections'] - control['processed_sections']} —Å–µ–∫—Ü–∏–π!")
    else:
        print("‚úì –í—Å–µ —Å–µ–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã")

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
    print(f"\n–í—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫:      {control['time_markers_count']}")
    if control['time_markers_count'] > 0:
        print(f"–ú–µ—Ç–∫–∏: {', '.join(control['original_time_markers'][:5])}...")

    # 3. –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å–∏–ª—å–Ω–æ–º —Å–æ–∫—Ä–∞—â–µ–Ω–∏–∏
    if ratio < 40:
        print(f"\n‚ö†Ô∏è  –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –¢–µ–∫—Å—Ç —Å–∏–ª—å–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏–ª—Å—è! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é.")
    elif ratio > 95:
        print(f"\n‚úì –¢–µ–∫—Å—Ç –ø–æ—á—Ç–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è (—Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)")

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    preview = clean_text[:500] + "..." if len(clean_text) > 500 else clean_text
    print(f"\n–ü—Ä–µ–≤—å—é –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:")
    print("-" * 60)
    print(preview)
    print("-" * 60)

    # –û—Ü–µ–Ω–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (~150 —Å–ª–æ–≤/–º–∏–Ω –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ, -5% = ~142 —Å–ª–æ–≤/–º–∏–Ω)
    word_count = len(clean_text.split())
    estimated_minutes = word_count / 142
    print(f"\n–°–ª–æ–≤: {word_count}")
    print(f"–û–∂–∏–¥–∞–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ~{estimated_minutes:.1f} –º–∏–Ω ({estimated_minutes*60:.0f} —Å–µ–∫)")

    # Debug: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    if DEBUG_SAVE_TEXT:
        debug_file = input_file.parent / f"{input_file.stem}_debug.txt"
        debug_file.write_text(clean_text, encoding='utf-8')
        print(f"\n[DEBUG] –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {debug_file.name}")

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ‚Äî –ê–£–î–ò–û –í –¢–£ –ñ–ï –ü–ê–ü–ö–£ —á—Ç–æ –∏ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª
    output_file = input_file.parent / f"{input_file.stem}.mp3"

    if await generate_audio(clean_text, output_file):
        print("\n" + "=" * 60)
        print("–ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–ê")
        print("=" * 60)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
        if output_file.exists():
            size_mb = output_file.stat().st_size / (1024 * 1024)
            print(f"‚úì –§–∞–π–ª —Å–æ–∑–¥–∞–Ω: {output_file.name}")
            print(f"‚úì –†–∞–∑–º–µ—Ä: {size_mb:.1f} MB")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ ffprobe –µ—Å–ª–∏ –µ—Å—Ç—å
            try:
                import subprocess
                result = subprocess.run(
                    ['ffprobe', '-i', str(output_file), '-show_entries',
                     'format=duration', '-v', 'quiet', '-of', 'csv=p=0'],
                    capture_output=True, text=True
                )
                if result.returncode == 0 and result.stdout.strip():
                    actual_duration = float(result.stdout.strip())
                    actual_minutes = actual_duration / 60

                    print(f"‚úì –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {actual_minutes:.1f} –º–∏–Ω ({actual_duration:.0f} —Å–µ–∫)")

                    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
                    # ~98 —Å–ª–æ–≤/–º–∏–Ω –¥–ª—è Svetlana -5%
                    expected_duration = word_count / 98 * 60
                    deviation = abs(actual_duration - expected_duration) / expected_duration * 100

                    if deviation < 20:
                        print(f"‚úì –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–Ω–∏—è–º (¬±{deviation:.0f}%)")
                    else:
                        print(f"‚ö†Ô∏è  –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: {deviation:.0f}%")
                        print(f"   –û–∂–∏–¥–∞–ª–æ—Å—å: ~{expected_duration/60:.1f} –º–∏–Ω")
            except FileNotFoundError:
                print("  (ffprobe –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω–∞)")

        print("\n" + "=" * 60)
        print("–ì–û–¢–û–í–û")
        print("=" * 60)
        print(f"\n–ê—É–¥–∏–æ: {output_file}")
        print(f"\n–î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:")
        print(f"  afplay '{output_file}'")
    else:
        print("\n‚úó –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")


if __name__ == "__main__":
    asyncio.run(main())
