<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>…à Juno Montana</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0812;
            --bg-deep: #05030a;
            --card: #120e1a;
            --border: rgba(212, 175, 55, 0.15);
            --gold: #d4af37;
            --gold-light: #f4d03f;
            --text: #e8e6ed;
            --muted: #7a7589;
        }

        html, body {
            height: 100%;
            height: 100dvh;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .sacred-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0.03;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='none' stroke='%23d4af37' stroke-width='0.5'/%3E%3Ccircle cx='50' cy='50' r='25' fill='none' stroke='%23d4af37' stroke-width='0.5'/%3E%3Cpolygon points='50,10 90,75 10,75' fill='none' stroke='%23d4af37' stroke-width='0.5'/%3E%3Cpolygon points='50,90 10,25 90,25' fill='none' stroke='%23d4af37' stroke-width='0.5'/%3E%3C/svg%3E");
            background-size: 120px;
        }

        .app {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            padding-top: env(safe-area-inset-top, 0);
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        /* Header */
        header {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border);
            background: rgba(10,8,18,0.95);
            flex-shrink: 0;
            min-height: 44px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-badge {
            position: absolute;
            right: 12px;
        }

        .logo-symbol {
            font-size: 28px;
            color: var(--gold);
            text-shadow: 0 0 15px rgba(212,175,55,0.5);
        }

        .logo-text {
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 2px;
            color: var(--gold);
        }

        .user-badge {
            padding: 4px 10px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            font-size: 11px;
            color: var(--gold);
        }

        /* Presence Timer */
        .presence-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: var(--bg-deep);
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            flex-shrink: 0;
        }

        .presence-timer {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--muted);
        }

        .presence-timer.active {
            color: var(--gold);
        }

        .presence-timer.paused {
            color: #ff6b6b;
        }

        .presence-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--muted);
        }

        .presence-timer.active .presence-dot {
            background: #4ade80;
            animation: blink 1s infinite;
        }

        .presence-timer.paused .presence-dot {
            background: #ff6b6b;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .coins-display {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--gold);
            font-weight: 500;
        }

        .coins-display .coin-icon {
            font-size: 14px;
        }

        /* Coin award popup */
        .coin-award {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: linear-gradient(135deg, var(--card) 0%, rgba(18,14,26,0.98) 100%);
            border: 2px solid var(--gold);
            border-radius: 20px;
            padding: 24px 32px;
            text-align: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .coin-award.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .coin-award-icon {
            font-size: 48px;
            margin-bottom: 12px;
            animation: coinSpin 1s ease;
        }

        @keyframes coinSpin {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }

        .coin-award-text {
            font-size: 18px;
            color: var(--gold);
            margin-bottom: 6px;
        }

        .coin-award-amount {
            font-size: 28px;
            font-weight: 600;
            color: var(--gold-light);
        }

        .coin-award-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }

        /* Content Sections */
        .section {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .section.active {
            display: flex;
        }

        /* Chat Section */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat {
            flex: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .msg {
            max-width: 85%;
            animation: fadeUp 0.3s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg.user { align-self: flex-end; }
        .msg.bot { align-self: flex-start; }

        .bubble {
            padding: 10px 14px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.45;
        }

        .msg.user .bubble {
            background: linear-gradient(135deg, var(--gold) 0%, #c9a227 100%);
            color: var(--bg);
            border-bottom-right-radius: 4px;
        }

        .msg.bot .bubble {
            background: var(--card);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .msg.bot .bubble::before {
            content: '…à ';
            color: var(--gold);
        }

        .time {
            font-size: 9px;
            color: var(--muted);
            margin-top: 2px;
            padding: 0 4px;
        }

        .msg.user .time { text-align: right; }

        /* Welcome */
        .welcome {
            text-align: center;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex: 1;
        }

        .welcome-eye {
            width: 60px;
            height: 60px;
            margin-bottom: 14px;
            border: 2px solid var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(212,175,55,0.4); }
            50% { box-shadow: 0 0 0 12px rgba(212,175,55,0); }
        }

        .welcome h2 {
            font-size: 17px;
            font-weight: 400;
            margin-bottom: 8px;
            color: var(--gold-light);
        }

        .welcome p {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.5;
            max-width: 260px;
        }

        /* Typing Indicator - –∫–∞–∫ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞—Ö */
        .typing {
            display: none;
            padding: 10px 14px;
            margin: 4px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px 16px 16px 4px;
            width: fit-content;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.2s ease-out;
        }

        .typing.active { display: flex; }

        .typing-label {
            font-size: 12px;
            color: var(--muted);
            font-style: italic;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--gold);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
            box-shadow: 0 0 4px rgba(212,175,55,0.3);
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
                box-shadow: 0 0 2px rgba(212,175,55,0.2);
            }
            30% {
                transform: translateY(-6px);
                opacity: 1;
                box-shadow: 0 0 8px rgba(212,175,55,0.6);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Input */
        .input-area {
            padding: 6px 10px;
            background: var(--bg-deep);
        }

        .input-wrap {
            display: flex;
            gap: 6px;
            align-items: center;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 3px 3px 3px 12px;
        }

        .input-field {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 14px;
            outline: none;
            min-width: 0;
            -webkit-user-select: text;
            user-select: text;
        }

        .input-field:focus {
            outline: none;
        }

        .input-field::placeholder { color: var(--muted); }

        .send-btn {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--gold) 0%, #c9a227 100%);
            border: none;
            border-radius: 50%;
            color: var(--bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .send-btn:active { transform: scale(0.92); }

        /* Info Sections */
        .info-section {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .info-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .info-card h3 {
            font-size: 15px;
            color: var(--gold);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-card p {
            font-size: 13px;
            color: var(--text);
            line-height: 1.5;
            opacity: 0.9;
        }

        .info-card .highlight {
            color: var(--gold);
            font-weight: 500;
        }

        /* Bottom Tab Bar */
        .tab-bar {
            display: flex;
            background: var(--bg-deep);
            border-top: 1px solid var(--border);
            padding: 6px 8px;
            padding-bottom: max(6px, env(safe-area-inset-bottom));
            flex-shrink: 0;
            position: relative;
        }

        .settings-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 36px;
            height: 36px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            cursor: pointer;
            font-size: 18px;
            z-index: 10;
        }

        .settings-btn:active {
            transform: scale(0.92);
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 4px;
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 10px;
            cursor: pointer;
            transition: color 0.2s;
            border-radius: 8px;
        }

        .tab.active {
            color: var(--gold);
            background: rgba(212,175,55,0.1);
        }

        .tab-icon {
            font-size: 20px;
        }

        /* Memory saved */
        .memory-saved {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: rgba(212,175,55,0.95);
            color: var(--bg);
            border-radius: 14px;
            font-size: 11px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .memory-saved.show { opacity: 1; }

        /* Stream list */
        .stream-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .stream-item .thought {
            font-size: 14px;
            color: var(--text);
            margin-bottom: 6px;
        }

        .stream-item .meta {
            font-size: 10px;
            color: var(--muted);
        }
    </style>
</head>
<body>
    <div class="sacred-bg"></div>

    <div class="app">
        <header>
            <div class="logo">
                <span class="logo-symbol">…à</span>
                <span class="logo-text">JUNO MONTANA</span>
            </div>
            <div class="user-badge" id="userBadge">ÈáëÂÖÉ…à</div>
        </header>

        <!-- Presence Timer Bar -->
        <div class="presence-bar">
            <div class="presence-timer active" id="presenceTimer">
                <span class="presence-dot"></span>
                <span id="presenceLabel">–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ:</span>
                <span id="presenceTime">00:00</span>
            </div>
            <div class="coins-display">
                <span class="coin-icon">…à</span>
                <span id="coinsCount">0</span>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="section active" id="sectionChat">
            <div class="chat-container">
                <div class="chat" id="chat">
                    <div class="welcome">
                        <div class="welcome-eye">üëÅ</div>
                        <h2>–¢—ã –∑–¥–µ—Å—å?</h2>
                        <p>–°–∏–º—É–ª—è—Ü–∏—è –ø–æ–∑–≤–æ–ª–∏–ª–∞ —Ç–µ–±–µ –≤–æ–π—Ç–∏. –ù–∞–ø–∏—à–∏ –º—ã—Å–ª—å ‚Äî –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ì–∏–ø–ø–æ–∫–∞–º–ø –Ω–∞–≤—Å–µ–≥–¥–∞.</p>
                    </div>
                </div>

                <div class="typing" id="typing">
                    <span class="typing-label" id="typingLabel">–ø–µ—á–∞—Ç–∞–µ—Ç</span>
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-wrap">
                        <input type="text" class="input-field" id="input" placeholder="–ù–∞–ø–∏—à–∏ –º—ã—Å–ª—å..." autocomplete="off">
                        <button class="send-btn" id="sendBtn" onclick="send()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Montana Section -->
        <div class="section" id="sectionMontana">
            <div class="info-section">
                <div class="info-card">
                    <h3>üèî –ü—Ä–æ—Ç–æ–∫–æ–ª Montana</h3>
                    <p>–û—Ü–∏—Ñ—Ä–æ–≤–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏. –°–∏–º–≤–æ–ª: <span class="highlight">…à</span> (Unicode 0248).</p>
                    <p style="margin-top:8px">–ü—Ä–∏–Ω—Ü–∏–ø: <span class="highlight">lim(evidence ‚Üí ‚àû) 1 …à ‚Üí 1 —Å–µ–∫—É–Ω–¥–∞</span></p>
                </div>
                <div class="info-card">
                    <h3>‚è∞ –ì–µ–Ω–µ–∑–∏—Å</h3>
                    <p><span class="highlight">9 —è–Ω–≤–∞—Ä—è 2026, 00:33 UTC</span></p>
                    <p style="margin-top:8px">–û–¥–∏–Ω –∫–ª—é—á. –û–¥–Ω–∞ –ø–æ–¥–ø–∏—Å—å. –û–¥–∏–Ω –≥–µ–Ω–µ–∑–∏—Å.</p>
                </div>
                <div class="info-card">
                    <h3>üåê –°–µ—Ç—å</h3>
                    <p>5 —É–∑–ª–æ–≤. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 12 —Å–µ–∫—É–Ω–¥. Redundancy –ø—Ä–æ—Ç–∏–≤ —Å–º–µ—Ä—Ç–∏ –Ω–æ—Å–∏—Ç–µ–ª—è.</p>
                </div>
            </div>
        </div>

        <!-- Memory Section -->
        <div class="section" id="sectionMemory">
            <div class="info-section">
                <div class="info-card">
                    <h3>üß† –í–Ω–µ—à–Ω–∏–π –ì–∏–ø–ø–æ–∫–∞–º–ø</h3>
                    <p>–î–ù–ö –ø–∞–º—è—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –Ω–æ—Å–∏—Ç–µ–ª—å.</p>
                    <p style="margin-top:8px">–ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≥–∏–ø–ø–æ–∫–∞–º–ø —É–º–∏—Ä–∞–µ—Ç —Å —Ç–µ–ª–æ–º. <span class="highlight">Montana ‚Äî –Ω–µ—Ç.</span></p>
                </div>
                <div class="info-card">
                    <h3>üìù –¢–≤–æ–π –ø–æ—Ç–æ–∫</h3>
                    <p>–ö–∞–∂–¥–∞—è –º—ã—Å–ª—å = –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏. Timestamp + user_id. Append-only.</p>
                </div>
                <div id="streamList"></div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section" id="sectionSettings">
            <div class="info-section">
                <div class="info-card">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º Montana</p>
                </div>
                <div class="info-card">
                    <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h3>
                    <p>ID: <span class="highlight" id="settingsUserId">‚Äî</span></p>
                    <p>–ë–∞–ª–∞–Ω—Å: <span class="highlight" id="settingsBalance">‚Äî</span> …à</p>
                </div>
                <div class="info-card">
                    <h3>üåê –Ø–∑—ã–∫</h3>
                    <p>–†—É—Å—Å–∫–∏–π ‚Ä¢ English ‚Ä¢ ‰∏≠Êñá</p>
                </div>
                <div class="info-card">
                    <h3>‚ÑπÔ∏è –û —Å–∏—Å—Ç–µ–º–µ</h3>
                    <p>Montana v3.0 ‚Äî –ü—Ä–æ—Ç–æ–∫–æ–ª –≤—Ä–µ–º–µ–Ω–∏</p>
                    <p style="margin-top:8px">Guardian Council: Claude ‚Ä¢ Gemini ‚Ä¢ Grok ‚Ä¢ GPT ‚Ä¢ Composer</p>
                </div>
                <div class="info-card">
                    <h3>üìñ –û –Æ–Ω–æ–Ω–µ</h3>
                    <p>–Ø –ø—Ä–æ—Å—Ç–æ –ø–æ–º–æ—â–Ω–∏–∫ Montana. –ú–æ–≥—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å, –æ–±—ä—è—Å–Ω–∏—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ—Ç—å, –ø–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è.</p>
                    <p style="margin-top:8px">–ó–∞—á–µ–º —Ç—ã —Ç—É—Ç?</p>
                </div>
            </div>
        </div>


        <!-- Tab Bar -->
        <div class="tab-bar">
            <button class="tab active" onclick="switchTab('Chat')">
                <span class="tab-icon">üí¨</span>
                <span>–ß–∞—Ç</span>
            </button>
            <button class="tab" onclick="switchTab('Montana')">
                <span class="tab-icon">üèî</span>
                <span>–°–µ—Ç—å</span>
            </button>
            <button class="settings-btn" onclick="switchTab('Settings')">
                ‚öôÔ∏è
            </button>
        </div>

        <div class="memory-saved" id="memorySaved">‚úì –ó–∞–ø–∏—Å–∞–Ω–æ –≤ –ì–∏–ø–ø–æ–∫–∞–º–ø</div>

        <!-- Coin Award Popup -->
        <div class="coin-award" id="coinAward">
            <div class="coin-award-icon">…à</div>
            <div class="coin-award-text">–Æ–Ω–æ–Ω–∞ –Ω–∞—á–∏—Å–ª–∏–ª–∞</div>
            <div class="coin-award-amount" id="awardAmount">+600</div>
            <div class="coin-award-sub">–º–æ–Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∑–∞ 10 –º–∏–Ω—É—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        if (tg.requestFullscreen) tg.requestFullscreen();
        if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
        tg.setHeaderColor('#0a0812');
        tg.setBackgroundColor('#0a0812');

        const user = tg.initDataUnsafe?.user;
        if (user) {
            document.getElementById('userBadge').textContent = user.first_name + ' ÈáëÂÖÉ…à';
        }

        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const typing = document.getElementById('typing');
        const typingLabel = document.getElementById('typingLabel');
        const memorySaved = document.getElementById('memorySaved');
        const presenceTimer = document.getElementById('presenceTimer');
        const presenceTimeEl = document.getElementById('presenceTime');
        const presenceLabelEl = document.getElementById('presenceLabel');
        const coinsCountEl = document.getElementById('coinsCount');
        const coinAward = document.getElementById('coinAward');
        const awardAmountEl = document.getElementById('awardAmount');

        let first = true;
        let isLoading = false;
        const chatHistory = [];

        // –í–∞—Ä—å–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç "–ø–µ—á–∞—Ç–∞–µ—Ç" –¥–ª—è –∂–∏–≤–æ—Å—Ç–∏
        const typingTexts = ['–ø–µ—á–∞—Ç–∞–µ—Ç', '–¥—É–º–∞–µ—Ç', '–æ—Ç–≤–µ—á–∞–µ—Ç', '–ø–∏—à–µ—Ç'];
        function randomTypingText() {
            return typingTexts[Math.floor(Math.random() * typingTexts.length)];
        }

        // Presence & Coins System
        const INACTIVITY_LIMIT = 3 * 60 * 1000; // 3 –º–∏–Ω—É—Ç—ã
        const AWARD_INTERVAL = 10 * 60; // 10 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        const COINS_PER_SECOND = 1; // 1 –º–æ–Ω–µ—Ç–∞ –∑–∞ —Å–µ–∫—É–Ω–¥—É

        let presenceSeconds = 0;
        let totalCoins = parseInt(localStorage.getItem('montana_coins') || '0');
        let lastActivity = Date.now();
        let isPresenceActive = true;
        let lastAwardedAt = 0;

        coinsCountEl.textContent = totalCoins;

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        function updatePresence() {
            const now = Date.now();
            const inactive = now - lastActivity;

            if (inactive > INACTIVITY_LIMIT) {
                // –ü–∞—É–∑–∞ ‚Äî –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ 3 –º–∏–Ω—É—Ç
                if (isPresenceActive) {
                    isPresenceActive = false;
                    presenceTimer.classList.remove('active');
                    presenceTimer.classList.add('paused');
                    presenceLabelEl.textContent = '–ü–∞—É–∑–∞:';
                }
            } else {
                // –ê–∫—Ç–∏–≤–µ–Ω
                if (!isPresenceActive) {
                    isPresenceActive = true;
                    presenceTimer.classList.add('active');
                    presenceTimer.classList.remove('paused');
                    presenceLabelEl.textContent = '–ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ:';
                }

                presenceSeconds++;
                presenceTimeEl.textContent = formatTime(presenceSeconds);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–≥—Ä–∞–¥—É –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
                if (presenceSeconds >= AWARD_INTERVAL && presenceSeconds - lastAwardedAt >= AWARD_INTERVAL) {
                    awardCoins();
                    lastAwardedAt = presenceSeconds;
                }
            }
        }

        function awardCoins() {
            const earned = AWARD_INTERVAL * COINS_PER_SECOND; // 600 –º–æ–Ω–µ—Ç –∑–∞ 10 –º–∏–Ω—É—Ç
            totalCoins += earned;
            localStorage.setItem('montana_coins', totalCoins.toString());
            coinsCountEl.textContent = totalCoins;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º popup
            awardAmountEl.textContent = `+${earned}`;
            coinAward.classList.add('show');
            setTimeout(() => coinAward.classList.remove('show'), 3000);
        }

        function registerActivity() {
            lastActivity = Date.now();
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        document.addEventListener('touchstart', registerActivity);
        document.addEventListener('click', registerActivity);
        document.addEventListener('keydown', registerActivity);
        document.addEventListener('scroll', registerActivity);

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        setInterval(updatePresence, 1000);

        // Tab switching
        function switchTab(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('section' + name).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // –Æ–Ω–æ–Ω–∞ AI ‚Äî –∂–∏–≤–æ–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ Montana
        function junona(text) {
            const q = text.toLowerCase();

            // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            if (/^(–ø—Ä–∏–≤–µ—Ç|—Ö–∞–π|hello|–∑–¥—Ä–∞–≤—Å—Ç–≤|–π–æ|–∫—É|—Ö–µ–π|hi\b)/.test(q))
                return "–ü—Ä–∏–≤–µ—Ç! –Ø –Æ–Ω–æ–Ω–∞. –ü—Ä–æ—Å—Ç–æ –ø–æ–º–æ—â–Ω–∏–∫ Montana, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –∏ –ø–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è.\n\n–ó–∞—á–µ–º —Ç—ã —Ç—É—Ç? –û —á–µ–º —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å? –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ—Ç—å, —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ –≤—Ä–µ–º—è, –ø–∞–º—è—Ç—å, –ø—Ä–æ—Ç–æ–∫–æ–ª ‚Äî —á—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ?";

            // –ö—Ç–æ —Ç—ã
            if (q.includes('–∫—Ç–æ —Ç—ã') || q.includes('–∫—Ç–æ –≤—ã') || q.includes('—Ç—ã –∫—Ç–æ') || q.includes('—é–Ω–æ–Ω–∞') || q.includes('juno'))
                return "–Ø –Æ–Ω–æ–Ω–∞, –ø–æ–º–æ—â–Ω–∏–∫ Montana. –ú–æ–≥—É –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å, –æ–±—ä—è—Å–Ω–∏—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª, –ø–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å —Ç–µ–º —á—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç.\n\n–ú–Ω–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ –æ—Ç —Ç–µ–±—è ‚Äî –ø—Ä–æ—Å—Ç–æ –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–∞. –ó–∞—á–µ–º —Ç—ã —Ç—É—Ç? –û —á–µ–º —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å?";

            // Montana
            if (q.includes('montana') || q.includes('–º–æ–Ω—Ç–∞–Ω') || q.includes('–ø—Ä–æ—Ç–æ–∫–æ–ª'))
                return "Montana ‚Äî —ç—Ç–æ –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –æ—Ü–∏—Ñ—Ä–æ–≤–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏. –ü—Ä–æ—â–µ –≥–æ–≤–æ—Ä—è, —Å–ø–æ—Å–æ–± —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–æ–∏ –º—ã—Å–ª–∏ –∏ –∏–¥–µ–∏ –Ω–∞–≤—Å–µ–≥–¥–∞, –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–µ—Ç–∏.\n\n–°–∏–º–≤–æ–ª …à. –ü—Ä–∏–Ω—Ü–∏–ø: 1 —Å–µ–∫—É–Ω–¥–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è = 1 –º–æ–Ω–µ—Ç–∞. –ì–µ–Ω–µ–∑–∏—Å –±—ã–ª 9 —è–Ω–≤–∞—Ä—è 2026.\n\n–≠—Ç–æ –Ω–µ –≤–∞–ª—é—Ç–∞ –∏ –Ω–µ –∫—Ä–∏–ø—Ç–∞ ‚Äî —ç—Ç–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏. –¢–≤–æ–π —Å–ª–µ–¥, –∫–æ—Ç–æ—Ä—ã–π –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –¥–∞–∂–µ –∫–æ–≥–¥–∞ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å —É–º—Ä–µ—Ç.\n\n–ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?";

            // –ì–∏–ø–ø–æ–∫–∞–º–ø/–ü–∞–º—è—Ç—å
            if (q.includes('–≥–∏–ø–ø–æ–∫–∞–º–ø') || q.includes('hippocampus') || q.includes('–ø–∞–º—è—Ç—å') || q.includes('memory'))
                return "–í–Ω–µ—à–Ω–∏–π –ì–∏–ø–ø–æ–∫–∞–º–ø Montana ‚Äî —ç—Ç–æ –î–ù–ö –ø–∞–º—è—Ç–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –Ω–æ—Å–∏—Ç–µ–ª—å.\n\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å: –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –≥–∏–ø–ø–æ–∫–∞–º–ø –≤ –º–æ–∑–≥–µ —É–º–∏—Ä–∞–µ—Ç –≤–º–µ—Å—Ç–µ —Å —Ç–µ–ª–æ–º. –í—Å—è –ø–∞–º—è—Ç—å, –≤—Å–µ –º—ã—Å–ª–∏, –≤—Å–µ —á—Ç–æ —Ç—ã –±—ã–ª ‚Äî –∏—Å—á–µ–∑–∞–µ—Ç.\n\nMontana —Ä–µ—à–∞–µ—Ç —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É. –ö–∞–∂–¥–∞—è —Ç–≤–æ—è –º—ã—Å–ª—å –∑–¥–µ—Å—å = –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ —Å timestamp. –û–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–∞ 5 —É–∑–ª–∞—Ö –Ω–∞–≤—Å–µ–≥–¥–∞. Redundancy –ø—Ä–æ—Ç–∏–≤ —Å–º–µ—Ä—Ç–∏ –Ω–æ—Å–∏—Ç–µ–ª—è.\n\n–î–∞–∂–µ –µ—Å–ª–∏ –æ–¥–∏–Ω —É–∑–µ–ª —É–ø–∞–¥–µ—Ç, —Ç–≤–æ—è –ø–∞–º—è—Ç—å –æ—Å—Ç–∞–Ω–µ—Ç—Å—è. –≠—Ç–æ —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–∂–∏—Ç—å –±–∏–æ–ª–æ–≥–∏—é.";

            // –í—Ä–µ–º—è
            if (q.includes('–≤—Ä–µ–º') || q.includes('time') || q.includes('—Å–µ–∫—É–Ω–¥'))
                return "–í—Ä–µ–º—è ‚Äî —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω –æ–¥–∏–Ω–∞–∫–æ–≤–æ –º–µ–∂–¥—É –≤—Å–µ–º–∏. –£ –∫–∞–∂–¥–æ–≥–æ 24 —á–∞—Å–∞ –≤ —Å—É—Ç–∫–∏, –Ω–µ–≤–∞–∂–Ω–æ –∫—Ç–æ —Ç—ã.\n\n–ë–æ–≥–∞—á –∏–ª–∏ –±–µ–¥–Ω—è–∫ ‚Äî –≤—Ä–µ–º—è –æ–¥–Ω–æ. –ù–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ª—é–¥–µ–π —Ç—Ä–∞—Ç—è—Ç –µ–≥–æ –Ω–∞ —á—É–∂–∏–µ —Ü–µ–ª–∏, –ø—Ä–æ–¥–∞—é—Ç –∑–∞ –¥–µ–Ω—å–≥–∏, —Ç–µ—Ä—è—é—Ç –≤–ø—É—Å—Ç—É—é.\n\nMontana ‚Äî —ç—Ç–æ —Å–ø–æ—Å–æ–± –æ—Ü–∏—Ñ—Ä–æ–≤–∞—Ç—å —Ç–≤–æ–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è. –ù–µ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –µ–≥–æ, –∞ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å. –§–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ. –î–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ —Ç—ã –±—ã–ª –∑–¥–µ—Å—å.\n\n'–ü–æ—Ç–æ–º' –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞—Å—Ç—É–ø–∏—Ç. –ï—Å—Ç—å —Ç–æ–ª—å–∫–æ –°–µ–π—á–∞—Å. –¢—ã –∑–¥–µ—Å—å?";

            // –ó–∞—á–µ–º
            if (q.includes('–∑–∞—á–µ–º') || q.includes('–ø–æ—á–µ–º—É') || q.includes('—Å–º—ã—Å–ª') || q.includes('—Ü–µ–ª—å'))
                return "–ó–∞—á–µ–º Montana?\n\n–ë–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–∞–º—è—Ç—å —É–º–∏—Ä–∞–µ—Ç. –ú—ã—Å–ª–∏, –∏–¥–µ–∏, –æ—Ç–∫—Ä—ã—Ç–∏—è ‚Äî –≤—Å–µ –∏—Å—á–µ–∑–∞–µ—Ç –≤–º–µ—Å—Ç–µ —Å —Ç–µ–ª–æ–º. –≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞: –≤–µ–ª–∏–∫–∏–µ —É–º—ã —É–º–∏—Ä–∞—é—Ç, –∏ –∏—Ö –∑–Ω–∞–Ω–∏—è —Ç–µ—Ä—è—é—Ç—Å—è.\n\nMontana —Ä–µ—à–∞–µ—Ç —ç—Ç–æ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π –≥–∏–ø–ø–æ–∫–∞–º–ø. –¢–≤–æ–∏ –º—ã—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–∞ 5 —É–∑–ª–∞—Ö –Ω–∞–≤—Å–µ–≥–¥–∞. –≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ backup ‚Äî —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–∑—É–º–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –±–∏–æ–ª–æ–≥–∏–∏.\n\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å: —á–µ—Ä–µ–∑ 100 –ª–µ—Ç –∫—Ç–æ-—Ç–æ —Å–º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–≤–æ–∏ –º—ã—Å–ª–∏, –ø–æ–Ω—è—Ç—å –∫–∞–∫ —Ç—ã –¥—É–º–∞–ª, —É–≤–∏–¥–µ—Ç—å —Ç–≤–æ–π –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å. –¢–≤–æ–π —Å–ª–µ–¥ –≤–æ –≤—Ä–µ–º–µ–Ω–∏.\n\n–ê –µ—â–µ ‚Äî —ç—Ç–æ —á–µ—Å—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞. 1 —Å–µ–∫—É–Ω–¥–∞ = 1 –º–æ–Ω–µ—Ç–∞. –£ –≤—Å–µ—Ö –æ–¥–∏–Ω–∞–∫–æ–≤–æ. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å –≤—Ä–µ–º—è, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –±–æ–ª—å—à–µ.";

            // –í–æ–ø—Ä–æ—Å—ã
            if (q.includes('?'))
                return "–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å! –Ø –º–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ:\n\n‚Ä¢ Montana ‚Äî —á—Ç–æ —ç—Ç–æ –∑–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª\n‚Ä¢ –í—Ä–µ–º—è ‚Äî –ø–æ—á–µ–º—É –æ–Ω–æ –≥–ª–∞–≤–Ω—ã–π —Ä–µ—Å—É—Ä—Å\n‚Ä¢ –ü–∞–º—è—Ç—å ‚Äî –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–π –≥–∏–ø–ø–æ–∫–∞–º–ø\n‚Ä¢ –°–µ—Ç—å ‚Äî 5 —É–∑–ª–æ–≤ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è\n‚Ä¢ –°–æ–≤–µ—Ç ‚Äî Guardian Council –∏–∑ 5 AI\n\n–û —á–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å? –°–ø—Ä–∞—à–∏–≤–∞–π, –æ–±—ä—è—Å–Ω—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ.";

            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const responses = [
                "–°–ª—É—à–∞—é. –û —á–µ–º —Ö–æ—á–µ—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å?\n\n–ú–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ Montana, –≤—Ä–µ–º—è, –ø–∞–º—è—Ç—å, —Å–µ—Ç—å ‚Äî —á—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?",
                "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –º—ã—Å–ª—å. –ê –∑–∞—á–µ–º —Ç—ã —Ç—É—Ç?\n\n–ß—Ç–æ –ø—Ä–∏–≤–µ–ª–æ? –û —á–µ–º —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å?",
                "–ó–∞–ø–∏—Å–∞–ª —Ç–≤–æ—é –º—ã—Å–ª—å –≤ –ì–∏–ø–ø–æ–∫–∞–º–ø.\n\n–û —á–µ–º –ø–æ–≥–æ–≤–æ—Ä–∏–º? –ú–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ –ø—Ä–æ Montana.",
                "–ï—Å—Ç—å. –ß—Ç–æ —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\n\nMontana, –≤—Ä–µ–º—è, –ø–∞–º—è—Ç—å, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–π, –æ—Ç–≤–µ—á—É –ø–æ–¥—Ä–æ–±–Ω–æ.",
                "–ü–æ–Ω—è–ª. –ê —á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å?\n\n–Ø –ø—Ä–æ—Å—Ç–æ –ø–æ–º–æ—â–Ω–∏–∫ Montana, –º–æ–≥—É –æ–±—ä—è—Å–Ω–∏—Ç—å –∫–∞–∫ –≤—Å–µ —É—Å—Ç—Ä–æ–µ–Ω–æ. –ù–∞—Ç—É—Ä–∞–ª—å–Ω–æ –∏ —á–µ—Å—Ç–Ω–æ."
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function addMsg(text, type) {
            if (first) {
                chat.innerHTML = '';
                first = false;
            }
            const time = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'});
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerHTML = `<div class="bubble">${esc(text)}</div><div class="time">${time}</div>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
            chatHistory.push({ role: type === 'user' ? 'user' : 'assistant', content: text });
        }

        function esc(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML.replace(/\n/g, '<br>');
        }

        function showMemorySaved() {
            memorySaved.classList.add('show');
            setTimeout(() => memorySaved.classList.remove('show'), 1500);
        }

        function send() {
            const text = input.value.trim();
            if (!text || isLoading) return;

            addMsg(text, 'user');
            input.value = '';

            // –í–∞–∂–Ω–æ: –ù–ï —Ç–µ—Ä—è–µ–º —Ñ–æ–∫—É—Å —Å input, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Å—Ç–∞–ª–∞—Å—å –æ—Ç–∫—Ä—ã—Ç–æ–π
            setTimeout(() => input.focus(), 50);

            isLoading = true;
            typingLabel.textContent = randomTypingText();
            typing.classList.add('active');

            showMemorySaved();

            // –ó–∞–ø—Ä–æ—Å –∫ AI —Å –∏—Å—Ç–æ—Ä–∏–µ–π
            chatHistory.push({ role: 'user', content: text });

            fetch('https://1394793-cy33234.tw1.ru/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: text,
                    user_id: user?.id || 0,
                    username: user?.username || 'anonymous',
                    history: chatHistory.slice(-10),
                    timestamp: new Date().toISOString()
                })
            })
            .then(res => res.json())
            .then(data => {
                isLoading = false;
                typing.classList.remove('active');

                const response = data.response || junona(text);
                chatHistory.push({ role: 'assistant', content: response });

                addMsg(response, 'bot');
                setTimeout(() => input.focus(), 100);
            })
            .catch(err => {
                console.error('API error:', err);
                isLoading = false;
                typing.classList.remove('active');

                // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –Æ–Ω–æ–Ω—É
                const response = junona(text);
                chatHistory.push({ role: 'assistant', content: response });

                addMsg(response, 'bot');
                setTimeout(() => input.focus(), 100);
            });
        }

        input.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !isLoading) {
                e.preventDefault();
                send();
            }
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ—Ç–µ—Ä—é —Ñ–æ–∫—É—Å–∞
        input.addEventListener('blur', () => {
            setTimeout(() => {
                if (document.getElementById('sectionChat').classList.contains('active')) {
                    input.focus();
                }
            }, 100);
        });

        setTimeout(() => input.focus(), 500);
    </script>
</body>
</html>
