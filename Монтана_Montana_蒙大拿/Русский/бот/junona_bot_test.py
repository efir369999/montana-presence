# junona_bot_test.py
# Ğ®Ğ½Ğ¾Ğ½Ğ° â€” Montana Test Edition
# Ğ¢Ğ•Ğ¡Ğ¢ĞĞ’ĞĞ¯ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹ + ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ‚Ğ¸

import os
import json
import logging
import asyncio
import subprocess
from pathlib import Path
from datetime import datetime

from dotenv import load_dotenv
load_dotenv(Path(__file__).parent / ".env")

from telegram import Update
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    ContextTypes, filters
)

# Montana Evolution
from session_manager import get_session_manager
from junona_agents import get_orchestrator

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                              ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN_JUNONA")
BOT_DIR = Path(__file__).parent

# Montana Evolution
ENABLE_PARALLEL_AGENTS = os.getenv("ENABLE_PARALLEL_AGENTS", "true").lower() == "true"
AGENT_MODE = os.getenv("AGENT_MODE", "synthesize")

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                              MONTANA NETWORK
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

NODES = {
    "amsterdam": {"ip": "72.56.102.240", "location": "ğŸ‡³ğŸ‡± Amsterdam"},
    "moscow": {"ip": "176.124.208.93", "location": "ğŸ‡·ğŸ‡º Moscow"},
    "almaty": {"ip": "91.200.148.93", "location": "ğŸ‡°ğŸ‡¿ Almaty"},
    "spb": {"ip": "188.225.58.98", "location": "ğŸ‡·ğŸ‡º St.Petersburg"},
    "novosibirsk": {"ip": "147.45.147.247", "location": "ğŸ‡·ğŸ‡º Novosibirsk"}
}

def check_node_status(ip: str) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑƒĞ·Ğ»Ğ° Ñ‡ĞµÑ€ĞµĞ· ping"""
    try:
        result = subprocess.run(
            ['ping', '-c', '1', '-W', '1', ip],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            timeout=2
        )
        return result.returncode == 0
    except:
        return False

async def get_network_status() -> str:
    """ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ‚Ğ¸ Montana"""
    response = "ğŸ” Montana Network Status\n\n"

    online_count = 0
    for node_name, node_info in NODES.items():
        online = check_node_status(node_info["ip"])
        status_emoji = "â—" if online else "â—‹"
        status_text = "ONLINE" if online else "OFFLINE"

        response += f"{status_emoji} {node_info['location']}\n"
        response += f"   {node_info['ip']} â€” {status_text}\n\n"

        if online:
            online_count += 1

    health = int((online_count / len(NODES)) * 100)
    response += f"Network Health: {health}%\n"
    response += f"Online: {online_count}/{len(NODES)} nodes"

    return response

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                              MONTANA AGENTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

session_manager = get_session_manager()

try:
    orchestrator = get_orchestrator()
    logger.info("ğŸ” Montana Evolution: Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹")
except Exception as e:
    orchestrator = None
    logger.warning(f"âš ï¸ ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹: {e}")
    ENABLE_PARALLEL_AGENTS = False

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                              ĞšĞĞœĞĞĞ”Ğ«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ°Ñ‡Ğ°Ğ»Ğ¾ â€” Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ"""
    user = update.message.from_user

    welcome = f"""Éˆ Montana Test Edition

ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {user.first_name}.

Ğ­Ñ‚Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ®Ğ½Ğ¾Ğ½Ñ‹.
Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:

/network - ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ‚Ğ¸ Montana
/help - Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒ

ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¸ÑˆĞ¸ â€” Ğ¸ Claude + GPT Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾."""

    await update.message.reply_text(welcome)

async def network_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ‚Ğ¸"""
    await update.message.chat.send_action("typing")
    status = await get_network_status()
    await update.message.reply_text(f"Éˆ\n\n{status}")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ"""
    help_text = """Éˆ Montana Test Edition

**Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**

1. ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹
   â€¢ Claude Sonnet 4.5 + GPT-4o Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
   â€¢ ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ°Ğ³ĞµĞ½Ñ‚ Ğ´ÑƒĞ¼Ğ°ĞµÑ‚ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾
   â€¢ Ğ®Ğ½Ğ¾Ğ½Ğ° ÑĞ¸Ğ½Ñ‚ĞµĞ·Ğ¸Ñ€ÑƒĞµÑ‚ Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚

2. Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ‚Ğ¸
   â€¢ /network â€” ÑÑ‚Ğ°Ñ‚ÑƒÑ 5 ÑƒĞ·Ğ»Ğ¾Ğ² Montana
   â€¢ ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸

**Dashboard:**
https://1394793-cy33234.tw1.ru

ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¸ÑˆĞ¸ Ñ‡Ñ‚Ğ¾ ÑƒĞ³Ğ¾Ğ´Ğ½Ğ¾ â€” ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ²ÑÑ‘ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚."""

    await update.message.reply_text(help_text)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                              ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜Ğš
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ â€” Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹"""
    user = update.message.from_user
    user_id = user.id
    text = update.message.text

    session = session_manager.get_active_session(user_id)
    await session.log_message("user", text)

    if ENABLE_PARALLEL_AGENTS and orchestrator:
        try:
            await update.message.chat.send_action("typing")

            response = await orchestrator.respond_parallel(
                prompt=text,
                context={
                    "prompt": text,
                    "lang": "ru",
                    "user_id": user_id,
                    "first_name": user.first_name
                },
                mode=AGENT_MODE
            )

            if response.thinking:
                await session.log_reasoning(
                    agent=response.agent,
                    thinking=response.thinking,
                    metadata={"tokens": response.tokens_used}
                )

            if response.signature_features:
                await session.save_cognitive_signature(
                    agent=response.agent,
                    signature=response.signature_features
                )

            await session.log_message("assistant", response.content, agent=response.agent)
            await update.message.reply_text(f"Éˆ\n\n{response.content}")

            logger.info(f"âœ“ {user.first_name}: {response.agent} ({response.tokens_used} tokens)")

        except Exception as e:
            logger.error(f"Montana Evolution error: {e}")
            await update.message.reply_text("Éˆ Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·.")
    else:
        await update.message.reply_text("Éˆ ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹.\n\nĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ API ĞºĞ»ÑÑ‡Ğ¸ Ğ² .env")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                              ERROR HANDLER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº"""
    logger.error(f"ĞÑˆĞ¸Ğ±ĞºĞ°: {context.error}", exc_info=context.error)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                              MAIN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == '__main__':
    if not TELEGRAM_TOKEN:
        logger.error("TELEGRAM_TOKEN_JUNONA not set")
        exit(1)

    application = ApplicationBuilder().token(TELEGRAM_TOKEN).build()
    application.add_error_handler(error_handler)

    # ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("network", network_command))
    application.add_handler(CommandHandler("help", help_command))

    # Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    logger.info("ğŸ” Ğ®Ğ½Ğ¾Ğ½Ğ° Montana Test Edition â€” Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ°")
    logger.info(f"   ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°Ğ³ĞµĞ½Ñ‚Ñ‹: {'Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹' if ENABLE_PARALLEL_AGENTS else 'Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½Ñ‹'}")
    logger.info(f"   Ğ ĞµĞ¶Ğ¸Ğ¼: {AGENT_MODE}")
    logger.info("   Dashboard: https://1394793-cy33234.tw1.ru")

    application.run_polling()
